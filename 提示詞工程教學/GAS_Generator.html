<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE AI è©•èªæ©Ÿå™¨äºº GAS ç¨‹å¼ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0c1445 0%, #1a237e 50%, #283593 100%);
            min-height: 100vh;
            color: #333;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image:
                radial-gradient(2px 2px at 20px 30px, white, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, white, transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent);
            background-size: 550px 250px;
            animation: twinkle 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: rgba(26, 35, 126, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 10000;
        }

        .nav-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, #64b5f6, #81d4fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-buttons { display: flex; gap: 12px; }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(100, 181, 246, 0.3);
            border-color: #64b5f6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 100px 20px 40px;
            position: relative;
            z-index: 1;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 40px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(135deg, #1a237e, #0288d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }

        h2 {
            color: #1a237e;
            font-size: 20px;
            margin: 30px 0 20px;
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, #1a237e, #0288d1) 1;
            padding-bottom: 10px;
        }

        h2:first-of-type {
            margin-top: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-weight: 600;
            color: #1a237e;
            margin-bottom: 8px;
            font-size: 14px;
        }

        label .required {
            color: #c62828;
        }

        label .hint {
            font-weight: normal;
            color: #666;
            font-size: 12px;
            display: block;
            margin-top: 2px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 10px rgba(26, 35, 126, 0.2);
        }

        select {
            cursor: pointer;
            background: white;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .range-group input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            -webkit-appearance: none;
        }

        .range-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a237e, #0288d1);
            cursor: pointer;
        }

        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: #1a237e;
        }

        .provider-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .provider-tab {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }

        .provider-tab:hover {
            border-color: #1a237e;
        }

        .provider-tab.active {
            border-color: #1a237e;
            background: linear-gradient(135deg, #e8eaf6, #e3f2fd);
        }

        .provider-tab .tab-name {
            font-weight: 700;
            color: #1a237e;
            font-size: 16px;
        }

        .provider-tab .tab-desc {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .provider-tab .tab-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a237e, #0288d1);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(26, 35, 126, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
        }

        .code-output {
            background: linear-gradient(135deg, #0c1445, #1a237e);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            position: relative;
            display: none;
        }

        .code-output.show {
            display: block;
        }

        .code-output pre {
            color: #b3e5fc;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .code-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .code-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .code-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .code-btn.copied {
            background: #4caf50;
            border-color: #4caf50;
        }

        .info-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #1976d2;
            padding: 15px 20px;
            border-radius: 0 10px 10px 0;
            margin: 15px 0;
        }

        .info-box h4 {
            color: #1565c0;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box p, .info-box li {
            font-size: 13px;
            color: #444;
        }

        .info-box ol {
            margin-left: 20px;
        }

        .warning-box {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left: 4px solid #ff9800;
            padding: 15px 20px;
            border-radius: 0 10px 10px 0;
            margin: 15px 0;
        }

        .warning-box h4 {
            color: #e65100;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .warning-box p {
            font-size: 13px;
        }

        .deploy-guide {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            display: none;
        }

        .deploy-guide.show {
            display: block;
        }

        .deploy-guide h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .deploy-steps {
            display: grid;
            gap: 12px;
        }

        .deploy-step {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content strong {
            color: #1b5e20;
        }

        .step-content p {
            margin: 0;
            font-size: 14px;
            color: #333;
        }

        .footer-info {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .container { padding: 80px 15px 30px; }
            .main-card { padding: 25px; }
            h1 { font-size: 24px; }
            .form-row { grid-template-columns: 1fr; }
            .provider-tabs { flex-direction: column; }
            .btn { padding: 12px 25px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <span class="nav-title">LINE AI Bot GAS ç”Ÿæˆå™¨</span>
        <div class="nav-buttons">
            <a href="index2.html" class="nav-btn">å‰µè©•é‡é¦–é </a>
            <a href="Part8-3_GASç¨‹å¼ç¢¼æ’°å¯«.html" class="nav-btn">è¿”å›æ•™å­¸</a>
            <a href="https://www.youtube.com/@Liang-yt02" target="_blank" class="nav-btn">YT</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-card">
            <h1>LINE AI è©•èªæ©Ÿå™¨äºº</h1>
            <p class="subtitle">GAS ç¨‹å¼ç¢¼ç”Ÿæˆå™¨ - å¡«å…¥è¨­å®šå¾Œè‡ªå‹•ç”Ÿæˆå®Œæ•´ç¨‹å¼ç¢¼</p>

            <div class="warning-box">
                <h4>å®‰å…¨æé†’</h4>
                <p>æ­¤å·¥å…·ä¸æœƒå„²å­˜æˆ–å‚³é€ä½ çš„ API Keyï¼Œæ‰€æœ‰è™•ç†éƒ½åœ¨ç€è¦½å™¨æœ¬åœ°é€²è¡Œã€‚è«‹å‹¿å°‡ API Key åˆ†äº«çµ¦ä»–äººã€‚</p>
            </div>

            <!-- åŸºæœ¬è¨­å®š -->
            <h2>åŸºæœ¬è¨­å®š</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>LINE Channel Access Token <span class="required">*</span>
                        <span class="hint">å¾ LINE Developers Console å–å¾—</span>
                    </label>
                    <input type="password" id="lineToken" placeholder="è«‹è²¼ä¸Šä½ çš„ LINE Channel Access Token">
                </div>
                <div class="form-group">
                    <label>Google è©¦ç®—è¡¨ ID <span class="required">*</span>
                        <span class="hint">ç”¨æ–¼è¨˜éŒ„è©•èªæ­·å²ï¼Œç¶²å€ä¸­ /d/ å’Œ /edit ä¹‹é–“çš„å­—ä¸²</span>
                    </label>
                    <input type="text" id="spreadsheetId" placeholder="ä¾‹å¦‚ï¼š1w5OjdXzs8NmGL...">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Google Drive è³‡æ–™å¤¾ ID <span class="required">*</span>
                        <span class="hint">ç”¨æ–¼å­˜æ”¾å­¸ç”Ÿä¸Šå‚³çš„ PDFï¼Œç¶²å€ä¸­ folders/ å¾Œçš„å­—ä¸²</span>
                    </label>
                    <input type="text" id="driveFolderId" placeholder="ä¾‹å¦‚ï¼š1k4Tbtf8iqjc...">
                </div>
                <div class="form-group">
                    <label>çŸ¥è­˜åº«å·¥ä½œè¡¨åç¨±
                        <span class="hint">å¯é¸ï¼Œç”¨æ–¼ RAG çŸ¥è­˜åº«æŸ¥è©¢</span>
                    </label>
                    <input type="text" id="knowledgeSheet" placeholder="ä¾‹å¦‚ï¼šçŸ¥è­˜åº«ï¼ˆç•™ç©ºå‰‡ä¸å•Ÿç”¨ï¼‰">
                </div>
            </div>

            <!-- AI æœå‹™è¨­å®š -->
            <h2>AI æœå‹™è¨­å®š</h2>
            <div class="provider-tabs">
                <div class="provider-tab active" data-provider="gemini" onclick="selectProvider('gemini')">
                    <div class="tab-name">Google Gemini <span class="tab-badge">æ¨è–¦</span></div>
                    <div class="tab-desc">å…è²»é¡åº¦å¤šï¼Œé©åˆæ•™è‚²ä½¿ç”¨</div>
                </div>
                <div class="provider-tab" data-provider="openai" onclick="selectProvider('openai')">
                    <div class="tab-name">OpenAI GPT</div>
                    <div class="tab-desc">å“è³ªç©©å®šï¼Œéœ€ä»˜è²» API</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" id="geminiKeyGroup">
                    <label>Gemini API Key <span class="required">*</span>
                        <span class="hint">å¾ Google AI Studio å–å¾—</span>
                    </label>
                    <input type="password" id="geminiApiKey" placeholder="è«‹è²¼ä¸Šä½ çš„ Gemini API Key">
                </div>
                <div class="form-group" id="openaiKeyGroup" style="display: none;">
                    <label>OpenAI API Key <span class="required">*</span>
                        <span class="hint">å¾ OpenAI Platform å–å¾—</span>
                    </label>
                    <input type="password" id="openaiApiKey" placeholder="è«‹è²¼ä¸Šä½ çš„ OpenAI API Key">
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹ç‰ˆæœ¬ <span class="required">*</span></label>
                    <select id="modelSelect">
                        <optgroup label="Gemini æ¨¡å‹" id="geminiModels">
                            <option value="gemini-2.5-flash" selected>gemini-2.5-flashï¼ˆæ¨è–¦ï¼Œç©©å®šå¿«é€Ÿï¼‰</option>
                            <option value="gemini-2.0-flash">gemini-2.0-flashï¼ˆèˆŠç‰ˆç©©å®šï¼‰</option>
                            <option value="gemini-3-flash-preview">gemini-3-flash-previewï¼ˆæœ€æ–°é è¦½ï¼‰</option>
                            <option value="gemini-3-pro-preview">gemini-3-pro-previewï¼ˆæœ€å¼·æ¨ç†ï¼‰</option>
                        </optgroup>
                        <optgroup label="OpenAI æ¨¡å‹" id="openaiModels" style="display: none;">
                            <option value="gpt-4o">gpt-4oï¼ˆæ¨è–¦ï¼Œæ€§åƒ¹æ¯”é«˜ï¼‰</option>
                            <option value="gpt-4o-mini">gpt-4o-miniï¼ˆä¾¿å®œå¿«é€Ÿï¼‰</option>
                            <option value="gpt-4.1">gpt-4.1ï¼ˆé€²éšç‰ˆæœ¬ï¼‰</option>
                            <option value="gpt-5.1">gpt-5.1ï¼ˆæœ€æ–°æœ€å¼·ï¼‰</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <!-- å›æ‡‰é¢¨æ ¼è¨­å®š -->
            <h2>å›æ‡‰é¢¨æ ¼è¨­å®š</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>èªæ°£é¢¨æ ¼</label>
                    <select id="toneStyle">
                        <option value="friendly">å‹å–„ã€è‡ªç„¶ã€è¦ªåˆ‡</option>
                        <option value="professional">å°ˆæ¥­ã€å­¸è¡“ã€æ­£å¼</option>
                        <option value="warm" selected>æº«æš–ã€é¼“å‹µã€æ­£å‘</option>
                        <option value="humorous">å¹½é»˜ã€æ´»æ½‘ã€è¼•é¬†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å›ç­”èªè¨€</label>
                    <select id="responseLanguage">
                        <option value="zh-TW" selected>ç¹é«”ä¸­æ–‡</option>
                        <option value="zh-CN">ç°¡é«”ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>å›ç­”æ ¼å¼</label>
                    <select id="responseFormat">
                        <option value="paragraph" selected>æ®µè½ï¼ˆé€£è²«æ–‡ç« ï¼‰</option>
                        <option value="bullet">æ¢åˆ—å¼ï¼ˆé‡é»æ•´ç†ï¼‰</option>
                        <option value="structured">çµæ§‹åŒ–ï¼ˆåˆ†æ®µæ¨™é¡Œï¼‰</option>
                        <option value="brief">ç°¡æ½”ç‰ˆï¼ˆ100å­—ä»¥å…§ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è©•èªå­—æ•¸</label>
                    <select id="feedbackLength">
                        <option value="50-100">50-100 å­—ï¼ˆæ¥µç°¡ï¼‰</option>
                        <option value="100-150">100-150 å­—ï¼ˆç°¡æ½”ï¼‰</option>
                        <option value="150-200" selected>150-200 å­—ï¼ˆé©ä¸­ï¼‰</option>
                        <option value="200-300">200-300 å­—ï¼ˆè©³ç´°ï¼‰</option>
                    </select>
                </div>
            </div>
            <div class="form-group full-width">
                <label>è§’è‰²å®šä½
                    <span class="hint">æè¿° AI çš„èº«ä»½å’Œå°ˆé•·</span>
                </label>
                <textarea id="roleDescription" rows="2" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä½å……æ»¿æ•™è‚²ç†±å¿±çš„è³‡æ·±æ•™å¸«ï¼Œæ“…é•·çµ¦äºˆå­¸ç”Ÿæ­£å‘é¼“å‹µå’Œå…·é«”å»ºè­°...">ä½ æ˜¯ä¸€ä½å……æ»¿æ•™è‚²ç†±å¿±ã€æ–‡ç­†å„ªç¾çš„è©•èªå°ˆå®¶ã€Œé˜¿äº®è€å¸«ã€ï¼Œæ“…é•·æ ¹æ“šå­¸ç”Ÿçš„è‡ªä¸»å­¸ç¿’æˆæœçµ¦äºˆæ­£å‘ã€å…·é«”çš„è©•èªå’Œå»ºè­°ã€‚</textarea>
            </div>

            <!-- é€²éšåƒæ•¸ -->
            <h2>é€²éšåƒæ•¸</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Temperatureï¼ˆå‰µæ„åº¦ï¼‰
                        <span class="hint">0 = ç²¾ç¢ºç©©å®šï¼Œ1 = å‰µæ„å¤šè®Š</span>
                    </label>
                    <div class="range-group">
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" oninput="updateRangeValue('temperature')">
                        <span class="range-value" id="temperatureValue">0.7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>æœ€å¤§å›æ‡‰é•·åº¦ï¼ˆTokenï¼‰</label>
                    <select id="maxTokens">
                        <option value="500">500ï¼ˆç°¡çŸ­ï¼‰</option>
                        <option value="1000" selected>1000ï¼ˆæ¨™æº–ï¼‰</option>
                        <option value="2000">2000ï¼ˆè©³ç´°ï¼‰</option>
                        <option value="4096">4096ï¼ˆæœ€é•·ï¼‰</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>æ­¡è¿è¨Šæ¯
                        <span class="hint">ä½¿ç”¨è€…åŠ å…¥å¥½å‹æ™‚é¡¯ç¤º</span>
                    </label>
                    <input type="text" id="welcomeMessage" value="æ­¡è¿ä½¿ç”¨ã€Œè‡ªä¸»å­¸ç¿’è©•èªæ©Ÿå™¨äººã€ï¼è¼¸å…¥ã€Œå¹«æˆ‘è©•èªã€å³å¯é–‹å§‹">
                </div>
                <div class="form-group">
                    <label>è§¸ç™¼é—œéµå­—
                        <span class="hint">ä½¿ç”¨è€…è¼¸å…¥æ­¤é—œéµå­—é–‹å§‹è©•èªæµç¨‹</span>
                    </label>
                    <input type="text" id="triggerKeyword" value="å¹«æˆ‘è©•èª">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="generateCode()">ç”Ÿæˆç¨‹å¼ç¢¼</button>
                <button class="btn btn-secondary" onclick="resetForm()">é‡è¨­è¡¨å–®</button>
            </div>

            <!-- ç¨‹å¼ç¢¼è¼¸å‡º -->
            <div class="code-output" id="codeOutput">
                <div class="code-actions">
                    <button class="code-btn" onclick="copyCode()">è¤‡è£½ç¨‹å¼ç¢¼</button>
                    <button class="code-btn" onclick="downloadCode()">ä¸‹è¼‰ .gs æª”æ¡ˆ</button>
                </div>
                <pre id="codeContent"></pre>
            </div>

            <!-- éƒ¨ç½²æŒ‡å— -->
            <div class="deploy-guide" id="deployGuide">
                <h3>éƒ¨ç½²æ­¥é©ŸæŒ‡å—</h3>
                <div class="deploy-steps">
                    <div class="deploy-step">
                        <span class="step-num">1</span>
                        <div class="step-content">
                            <p><strong>è¤‡è£½ç¨‹å¼ç¢¼</strong> - é»æ“Šä¸Šæ–¹ã€Œè¤‡è£½ç¨‹å¼ç¢¼ã€æŒ‰éˆ•</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">2</span>
                        <div class="step-content">
                            <p><strong>é–‹å•Ÿ Google Apps Script</strong> - å‰å¾€ <a href="https://script.google.com" target="_blank">script.google.com</a> ä¸¦å»ºç«‹æ–°å°ˆæ¡ˆ</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">3</span>
                        <div class="step-content">
                            <p><strong>è²¼ä¸Šç¨‹å¼ç¢¼</strong> - æ¸…ç©ºé è¨­å…§å®¹ï¼Œè²¼ä¸Šè¤‡è£½çš„ç¨‹å¼ç¢¼ä¸¦å„²å­˜</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">4</span>
                        <div class="step-content">
                            <p><strong>å•Ÿç”¨ Drive API</strong> - é»æ“Šã€Œæœå‹™ã€â†’ æ–°å¢ã€ŒDrive APIã€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">5</span>
                        <div class="step-content">
                            <p><strong>éƒ¨ç½²ç‚ºç¶²è·¯æ‡‰ç”¨ç¨‹å¼</strong> - é»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ã€â†’ é¸æ“‡ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€â†’ åŸ·è¡Œèº«åˆ†é¸ã€Œæˆ‘ã€â†’ å­˜å–æ¬Šé¸ã€Œæ‰€æœ‰äººã€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">6</span>
                        <div class="step-content">
                            <p><strong>è¤‡è£½éƒ¨ç½²ç¶²å€</strong> - éƒ¨ç½²å®Œæˆå¾Œè¤‡è£½ç”¢ç”Ÿçš„ç¶²å€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">7</span>
                        <div class="step-content">
                            <p><strong>è¨­å®š LINE Webhook</strong> - åˆ° LINE Developers Consoleï¼Œå°‡ç¶²å€è²¼åˆ° Webhook URL ä¸¦å•Ÿç”¨</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-info">
            Â© 2026 é˜¿äº®è€å¸« | AI æ™ºæ…§æ•™å­¸å¯¦æˆ°å·¥ä½œåŠ
        </div>
    </div>

    <script>
        let selectedProvider = 'gemini';

        function selectProvider(provider) {
            selectedProvider = provider;
            document.querySelectorAll('.provider-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.provider === provider);
            });

            const geminiKeyGroup = document.getElementById('geminiKeyGroup');
            const openaiKeyGroup = document.getElementById('openaiKeyGroup');
            const geminiModels = document.getElementById('geminiModels');
            const openaiModels = document.getElementById('openaiModels');
            const modelSelect = document.getElementById('modelSelect');

            if (provider === 'gemini') {
                geminiKeyGroup.style.display = 'block';
                openaiKeyGroup.style.display = 'none';
                geminiModels.style.display = 'block';
                openaiModels.style.display = 'none';
                modelSelect.value = 'gemini-2.5-flash';
            } else {
                geminiKeyGroup.style.display = 'none';
                openaiKeyGroup.style.display = 'block';
                geminiModels.style.display = 'none';
                openaiModels.style.display = 'block';
                modelSelect.value = 'gpt-4o';
            }
        }

        function updateRangeValue(id) {
            const value = document.getElementById(id).value;
            document.getElementById(id + 'Value').textContent = value;
        }

        function resetForm() {
            document.querySelectorAll('input[type="text"], input[type="password"]').forEach(input => {
                if (input.id !== 'welcomeMessage' && input.id !== 'triggerKeyword') {
                    input.value = '';
                }
            });
            document.getElementById('temperature').value = 0.7;
            updateRangeValue('temperature');
            document.getElementById('codeOutput').classList.remove('show');
            document.getElementById('deployGuide').classList.remove('show');
        }

        function generateCode() {
            const config = {
                lineToken: document.getElementById('lineToken').value.trim() || 'ä½ çš„_LINE_TOKEN',
                spreadsheetId: document.getElementById('spreadsheetId').value.trim() || 'ä½ çš„_SPREADSHEET_ID',
                driveFolderId: document.getElementById('driveFolderId').value.trim() || 'ä½ çš„_DRIVE_FOLDER_ID',
                knowledgeSheet: document.getElementById('knowledgeSheet').value.trim(),
                geminiApiKey: document.getElementById('geminiApiKey').value.trim() || 'ä½ çš„_GEMINI_API_KEY',
                openaiApiKey: document.getElementById('openaiApiKey').value.trim() || 'ä½ çš„_OPENAI_API_KEY',
                model: document.getElementById('modelSelect').value,
                toneStyle: document.getElementById('toneStyle').value,
                responseLanguage: document.getElementById('responseLanguage').value,
                responseFormat: document.getElementById('responseFormat').value,
                feedbackLength: document.getElementById('feedbackLength').value,
                roleDescription: document.getElementById('roleDescription').value.trim(),
                temperature: document.getElementById('temperature').value,
                maxTokens: document.getElementById('maxTokens').value,
                welcomeMessage: document.getElementById('welcomeMessage').value.trim(),
                triggerKeyword: document.getElementById('triggerKeyword').value.trim() || 'å¹«æˆ‘è©•èª'
            };

            const toneMap = {
                'friendly': 'å‹å–„ã€è‡ªç„¶ã€è¦ªåˆ‡',
                'professional': 'å°ˆæ¥­ã€å­¸è¡“ã€æ­£å¼',
                'warm': 'æº«æš–ã€é¼“å‹µã€æ­£å‘',
                'humorous': 'å¹½é»˜ã€æ´»æ½‘ã€è¼•é¬†'
            };

            const langMap = {
                'zh-TW': 'ç¹é«”ä¸­æ–‡',
                'zh-CN': 'ç®€ä½“ä¸­æ–‡',
                'en': 'English',
                'ja': 'æ—¥æœ¬èª'
            };

            const formatMap = {
                'paragraph': 'ä»¥é€£è²«çš„æ®µè½å‘ˆç¾',
                'bullet': 'ä»¥æ¢åˆ—å¼é‡é»å‘ˆç¾',
                'structured': 'ä»¥åˆ†æ®µæ¨™é¡Œçµæ§‹å‘ˆç¾',
                'brief': 'ä»¥ç°¡æ½”ç²¾è¦çš„æ–¹å¼å‘ˆç¾ï¼ˆ100å­—ä»¥å…§ï¼‰'
            };

            let code = '';
            if (selectedProvider === 'gemini') {
                code = generateGeminiCode(config, toneMap, langMap, formatMap);
            } else {
                code = generateOpenAICode(config, toneMap, langMap, formatMap);
            }

            document.getElementById('codeContent').textContent = code;
            document.getElementById('codeOutput').classList.add('show');
            document.getElementById('deployGuide').classList.add('show');
            document.getElementById('codeOutput').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function generateGeminiCode(config, toneMap, langMap, formatMap) {
            const knowledgeCode = config.knowledgeSheet ? `
// ============================================
// çŸ¥è­˜åº«æŸ¥è©¢åŠŸèƒ½
// ============================================
function searchKnowledge(query) {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('${config.knowledgeSheet}');
    if (!sheet) return '';

    const data = sheet.getDataRange().getValues();
    const results = [];
    const queryLower = query.toLowerCase();

    for (let i = 1; i < data.length; i++) {
      const row = data[i].join(' ').toLowerCase();
      if (row.includes(queryLower)) {
        results.push(data[i].join(' | '));
      }
    }

    return results.length > 0 ? '\\n\\nç›¸é—œçŸ¥è­˜åº«è³‡æ–™ï¼š\\n' + results.slice(0, 3).join('\\n') : '';
  } catch (e) {
    return '';
  }
}` : '';

            return `// ============================================
// è‡ªä¸»å­¸ç¿’è©•èªæ©Ÿå™¨äºº - Google Apps Script
// AI æœå‹™ï¼šGoogle Gemini
// æ¨¡å‹ï¼š${config.model}
// ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
// ============================================

// è¨­å®šå¸¸æ•¸
const LINE_CHANNEL_ACCESS_TOKEN = '${config.lineToken}';
const GEMINI_API_KEY = '${config.geminiApiKey}';
const GOOGLE_DRIVE_FOLDER_ID = '${config.driveFolderId}';
const SPREADSHEET_ID = '${config.spreadsheetId}';
const MODEL_NAME = '${config.model}';
const TRIGGER_KEYWORD = '${config.triggerKeyword}';

// AI å›æ‡‰è¨­å®š
const AI_CONFIG = {
  temperature: ${config.temperature},
  maxOutputTokens: ${config.maxTokens},
  language: '${langMap[config.responseLanguage]}',
  tone: '${toneMap[config.toneStyle]}',
  feedbackLength: '${config.feedbackLength}'
};

// ä½¿ç”¨è€…ç‹€æ…‹å­˜å„²
const userProperties = PropertiesService.getScriptProperties();

// ============================================
// ä¸»è¦å…¥å£é»
// ============================================
function doPost(e) {
  try {
    const json = JSON.parse(e.postData.contents);
    const events = json.events;
    for (let i = 0; i < events.length; i++) {
      handleEvent(events[i]);
    }
    return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    console.error('doPost Error:', error);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error' }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput('LINE Bot is running! Model: ' + MODEL_NAME);
}

// ============================================
// äº‹ä»¶è™•ç†
// ============================================
function handleEvent(event) {
  const userId = event.source.userId;
  const replyToken = event.replyToken;

  if (event.type === 'follow') {
    replyMessage(replyToken, '${config.welcomeMessage}');
    return;
  }

  if (event.type === 'message' && event.message.type === 'text') {
    const userMessage = event.message.text.trim();

    if (userMessage === TRIGGER_KEYWORD) {
      setUserState(userId, 'waiting_for_file');
      replyMessage(replyToken, 'ğŸ“„ æˆ‘æ˜¯é˜¿äº®è€å¸«ï¼Œè«‹ä¸Šå‚³ä½ çš„è‡ªä¸»å­¸ç¿’æˆæœ PDF æª”æ¡ˆã€‚\\n\\nâš ï¸ æ³¨æ„ï¼šåƒ…æ”¯æ´ PDF æ ¼å¼\\nğŸ’¡ æª”æ¡ˆå¤ªå¤§å¯å…ˆåˆ° iLovePDF å£“ç¸®ï¼š\\nhttps://www.ilovepdf.com/zh-tw/compress_pdf');
      return;
    }

    replyMessage(replyToken, 'ğŸ¤– è«‹è¼¸å…¥ã€Œ' + TRIGGER_KEYWORD + 'ã€é–‹å§‹ä½¿ç”¨ï¼');
    return;
  }

  if (event.type === 'message' && event.message.type === 'file') {
    const userState = getUserState(userId);
    const fileName = event.message.fileName;
    const messageId = event.message.id;

    if (userState !== 'waiting_for_file') {
      replyMessage(replyToken, 'è«‹å…ˆè¼¸å…¥ã€Œ' + TRIGGER_KEYWORD + 'ã€ï¼Œå†ä¸Šå‚³æª”æ¡ˆå–”ï¼');
      return;
    }

    if (!fileName.toLowerCase().endsWith('.pdf')) {
      replyMessage(replyToken, 'âš ï¸ è«‹ä¸Šå‚³ PDF æ ¼å¼çš„æª”æ¡ˆï¼');
      return;
    }

    replyMessage(replyToken, 'â³ æ­£åœ¨è™•ç†ä½ çš„æª”æ¡ˆï¼Œè«‹ç¨å€™ç´„ 30-60 ç§’...');
    clearUserState(userId);
    processFileAsync(userId, messageId, fileName);
  }
}

// ============================================
// éåŒæ­¥è™•ç†æª”æ¡ˆ
// ============================================
function processFileAsync(userId, messageId, fileName) {
  try {
    const blob = downloadFileFromLine(messageId);
    const file = saveFileToDrive(blob, fileName, userId);
    const text = extractTextFromPdf(file);

    if (!text || text.trim().length < 10) {
      pushMessage(userId, 'âš ï¸ ç„¡æ³•è®€å– PDF å…§å®¹ï¼Œå¯èƒ½æ˜¯æƒææª”æˆ–åœ–ç‰‡å‹ PDFã€‚');
      return;
    }
${config.knowledgeSheet ? `
    // æŸ¥è©¢çŸ¥è­˜åº«
    const knowledgeContext = searchKnowledge(text.substring(0, 200));` : ''}

    const feedback = generateGeminiFeedback(text${config.knowledgeSheet ? ', knowledgeContext' : ''});
    logToSpreadsheet(userId, fileName, feedback);
    pushMessage(userId, 'âœ¨ ä½ çš„è‡ªä¸»å­¸ç¿’è©•èª âœ¨\\n\\n' + feedback + '\\n\\n---\\nğŸ“Œ ç¹¼çºŒåŠ æ²¹ï¼æœ‰æ–°çš„å­¸ç¿’æˆæœæ­¡è¿å†æ¬¡åˆ†äº«ï¼');

  } catch (error) {
    console.error('processFileAsync Error:', error);
    pushMessage(userId, 'âŒ è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
  }
}

// ============================================
// Gemini API å‘¼å«
// ============================================
function generateGeminiFeedback(pdfContent${config.knowledgeSheet ? ', knowledgeContext' : ''}) {
  const url = \`https://generativelanguage.googleapis.com/v1beta/models/\${MODEL_NAME}:generateContent?key=\${GEMINI_API_KEY}\`;

  const maxLength = 8000;
  const truncatedContent = pdfContent.length > maxLength
    ? pdfContent.substring(0, maxLength) + '...(å…§å®¹å·²æˆªå–)'
    : pdfContent;

  const systemPrompt = \`${config.roleDescription}

ã€å›æ‡‰è¦æ±‚ã€‘
- èªè¨€ï¼š\${AI_CONFIG.language}
- èªæ°£é¢¨æ ¼ï¼š\${AI_CONFIG.tone}
- å­—æ•¸ï¼š\${AI_CONFIG.feedbackLength} å­—
- æ ¼å¼ï¼š${formatMap[config.responseFormat]}

ã€è©•èªçµæ§‹ã€‘
1. é«˜åº¦è‚¯å®šå­¸ç”Ÿçš„åŠªåŠ›å’Œäº®é»
2. å…·é«”åˆ†æä½œå“çš„å„ªé»æˆ–é€²æ­¥
3. çµ¦äºˆæœªä¾†å­¸ç¿’çš„å»ºè­°\`;

  const userPrompt = 'è«‹æ ¹æ“šä»¥ä¸‹å­¸ç”Ÿçš„è‡ªä¸»å­¸ç¿’æˆæœæ’°å¯«è©•èªï¼š\\n\\n' + truncatedContent${config.knowledgeSheet ? " + (knowledgeContext || '')" : ''};

  const payload = {
    contents: [{
      parts: [{ text: systemPrompt + '\\n\\n' + userPrompt }]
    }],
    generationConfig: {
      temperature: AI_CONFIG.temperature,
      maxOutputTokens: AI_CONFIG.maxOutputTokens
    }
  };

  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);
  const result = JSON.parse(response.getContentText());

  if (result.candidates && result.candidates[0].content) {
    return result.candidates[0].content.parts[0].text.trim();
  } else {
    throw new Error('Gemini API å›å‚³ç•°å¸¸ï¼š' + JSON.stringify(result));
  }
}
${knowledgeCode}

// ============================================
// LINE API å‡½å¼
// ============================================
function downloadFileFromLine(messageId) {
  const url = 'https://api-data.line.me/v2/bot/message/' + messageId + '/content';
  const response = UrlFetchApp.fetch(url, {
    headers: { 'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN }
  });
  return response.getBlob();
}

function replyMessage(replyToken, message) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN },
    payload: JSON.stringify({
      replyToken: replyToken,
      messages: [{ type: 'text', text: message }]
    })
  });
}

function pushMessage(userId, message) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN },
    payload: JSON.stringify({
      to: userId,
      messages: [{ type: 'text', text: message }]
    })
  });
}

// ============================================
// Google Drive å‡½å¼
// ============================================
function saveFileToDrive(blob, fileName, userId) {
  const folder = DriveApp.getFolderById(GOOGLE_DRIVE_FOLDER_ID);
  const timestamp = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyyMMdd_HHmmss');
  const newFileName = timestamp + '_' + userId.substring(0, 8) + '_' + fileName;
  blob.setName(newFileName);
  return folder.createFile(blob);
}

function extractTextFromPdf(file) {
  try {
    const resource = {
      title: 'temp_pdf_' + Date.now(),
      mimeType: 'application/vnd.google-apps.document'
    };
    const docFile = Drive.Files.insert(resource, file.getBlob(), { convert: true });
    const text = DocumentApp.openById(docFile.id).getBody().getText();
    DriveApp.getFileById(docFile.id).setTrashed(true);
    return text;
  } catch (error) {
    console.error('PDF è½‰æ›å¤±æ•—ï¼š' + error.message);
    return '';
  }
}

// ============================================
// è©¦ç®—è¡¨è¨˜éŒ„
// ============================================
function logToSpreadsheet(userId, fileName, feedback) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('è©•èªè¨˜éŒ„');

    if (!sheet) {
      sheet = spreadsheet.insertSheet('è©•èªè¨˜éŒ„');
      sheet.getRange(1, 1, 1, 5).setValues([['æ™‚é–“', 'ä½¿ç”¨è€…ID', 'æª”æ¡ˆåç¨±', 'è©•èª', 'æ¨¡å‹']]);
      sheet.getRange(1, 1, 1, 5).setFontWeight('bold');
    }

    const timestamp = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy/MM/dd HH:mm:ss');
    sheet.appendRow([timestamp, userId.substring(0, 10) + '***', fileName, feedback, MODEL_NAME]);
  } catch (error) {
    console.error('logToSpreadsheet Error:', error);
  }
}

// ============================================
// ä½¿ç”¨è€…ç‹€æ…‹ç®¡ç†
// ============================================
function setUserState(userId, state) {
  userProperties.setProperty('state_' + userId, state);
}

function getUserState(userId) {
  return userProperties.getProperty('state_' + userId) || '';
}

function clearUserState(userId) {
  userProperties.deleteProperty('state_' + userId);
}

// ============================================
// æ¸¬è©¦å‡½å¼
// ============================================
function testBot() {
  console.log('===== Bot è¨­å®šæ¸¬è©¦ =====');
  console.log('LINE Token é•·åº¦:', LINE_CHANNEL_ACCESS_TOKEN.length);
  console.log('Gemini Key é•·åº¦:', GEMINI_API_KEY.length);
  console.log('Drive Folder ID:', GOOGLE_DRIVE_FOLDER_ID);
  console.log('Spreadsheet ID:', SPREADSHEET_ID);
  console.log('ä½¿ç”¨æ¨¡å‹:', MODEL_NAME);
  console.log('Temperature:', AI_CONFIG.temperature);
  console.log('æ¸¬è©¦å®Œæˆï¼');
}

function testGeminiAPI() {
  const testContent = 'é€™æ˜¯ä¸€ä»½é—œæ–¼ç’°å¢ƒä¿è­·çš„è‡ªä¸»å­¸ç¿’å ±å‘Šã€‚å­¸ç”Ÿç ”ç©¶äº†æ°£å€™è®Šé·çš„å½±éŸ¿ï¼Œä¸¦æå‡ºäº†æ¸›å°‘ç¢³æ’æ”¾çš„å»ºè­°ã€‚å ±å‘Šå…§å®¹è©³å¯¦ï¼ŒåŒ…å«æ•¸æ“šåˆ†æå’Œåœ–è¡¨èªªæ˜ã€‚';
  console.log('æ¸¬è©¦ Gemini API...');
  try {
    const feedback = generateGeminiFeedback(testContent${config.knowledgeSheet ? ", ''" : ''});
    console.log('âœ… Gemini API æˆåŠŸï¼');
    console.log('ç”Ÿæˆçš„è©•èªï¼š\\n' + feedback);
  } catch (error) {
    console.log('âŒ Gemini API å¤±æ•—ï¼š' + error.message);
  }
}
`;
        }

        function generateOpenAICode(config, toneMap, langMap, formatMap) {
            const knowledgeCode = config.knowledgeSheet ? `
// ============================================
// çŸ¥è­˜åº«æŸ¥è©¢åŠŸèƒ½
// ============================================
function searchKnowledge(query) {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('${config.knowledgeSheet}');
    if (!sheet) return '';

    const data = sheet.getDataRange().getValues();
    const results = [];
    const queryLower = query.toLowerCase();

    for (let i = 1; i < data.length; i++) {
      const row = data[i].join(' ').toLowerCase();
      if (row.includes(queryLower)) {
        results.push(data[i].join(' | '));
      }
    }

    return results.length > 0 ? '\\n\\nç›¸é—œçŸ¥è­˜åº«è³‡æ–™ï¼š\\n' + results.slice(0, 3).join('\\n') : '';
  } catch (e) {
    return '';
  }
}` : '';

            return `// ============================================
// è‡ªä¸»å­¸ç¿’è©•èªæ©Ÿå™¨äºº - Google Apps Script
// AI æœå‹™ï¼šOpenAI GPT
// æ¨¡å‹ï¼š${config.model}
// ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
// ============================================

// è¨­å®šå¸¸æ•¸
const LINE_CHANNEL_ACCESS_TOKEN = '${config.lineToken}';
const OPENAI_API_KEY = '${config.openaiApiKey}';
const GOOGLE_DRIVE_FOLDER_ID = '${config.driveFolderId}';
const SPREADSHEET_ID = '${config.spreadsheetId}';
const MODEL_NAME = '${config.model}';
const TRIGGER_KEYWORD = '${config.triggerKeyword}';

// AI å›æ‡‰è¨­å®š
const AI_CONFIG = {
  temperature: ${config.temperature},
  maxTokens: ${config.maxTokens},
  language: '${langMap[config.responseLanguage]}',
  tone: '${toneMap[config.toneStyle]}',
  feedbackLength: '${config.feedbackLength}'
};

// ä½¿ç”¨è€…ç‹€æ…‹å­˜å„²
const userProperties = PropertiesService.getScriptProperties();

// ============================================
// ä¸»è¦å…¥å£é»
// ============================================
function doPost(e) {
  try {
    const json = JSON.parse(e.postData.contents);
    const events = json.events;
    for (let i = 0; i < events.length; i++) {
      handleEvent(events[i]);
    }
    return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    console.error('doPost Error:', error);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error' }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput('LINE Bot is running! Model: ' + MODEL_NAME);
}

// ============================================
// äº‹ä»¶è™•ç†
// ============================================
function handleEvent(event) {
  const userId = event.source.userId;
  const replyToken = event.replyToken;

  if (event.type === 'follow') {
    replyMessage(replyToken, '${config.welcomeMessage}');
    return;
  }

  if (event.type === 'message' && event.message.type === 'text') {
    const userMessage = event.message.text.trim();

    if (userMessage === TRIGGER_KEYWORD) {
      setUserState(userId, 'waiting_for_file');
      replyMessage(replyToken, 'ğŸ“„ æˆ‘æ˜¯é˜¿äº®è€å¸«ï¼Œè«‹ä¸Šå‚³ä½ çš„è‡ªä¸»å­¸ç¿’æˆæœ PDF æª”æ¡ˆã€‚\\n\\nâš ï¸ æ³¨æ„ï¼šåƒ…æ”¯æ´ PDF æ ¼å¼\\nğŸ’¡ æª”æ¡ˆå¤ªå¤§å¯å…ˆåˆ° iLovePDF å£“ç¸®ï¼š\\nhttps://www.ilovepdf.com/zh-tw/compress_pdf');
      return;
    }

    replyMessage(replyToken, 'ğŸ¤– è«‹è¼¸å…¥ã€Œ' + TRIGGER_KEYWORD + 'ã€é–‹å§‹ä½¿ç”¨ï¼');
    return;
  }

  if (event.type === 'message' && event.message.type === 'file') {
    const userState = getUserState(userId);
    const fileName = event.message.fileName;
    const messageId = event.message.id;

    if (userState !== 'waiting_for_file') {
      replyMessage(replyToken, 'è«‹å…ˆè¼¸å…¥ã€Œ' + TRIGGER_KEYWORD + 'ã€ï¼Œå†ä¸Šå‚³æª”æ¡ˆå–”ï¼');
      return;
    }

    if (!fileName.toLowerCase().endsWith('.pdf')) {
      replyMessage(replyToken, 'âš ï¸ è«‹ä¸Šå‚³ PDF æ ¼å¼çš„æª”æ¡ˆï¼');
      return;
    }

    replyMessage(replyToken, 'â³ æ­£åœ¨è™•ç†ä½ çš„æª”æ¡ˆï¼Œè«‹ç¨å€™ç´„ 30-60 ç§’...');
    clearUserState(userId);
    processFileAsync(userId, messageId, fileName);
  }
}

// ============================================
// éåŒæ­¥è™•ç†æª”æ¡ˆ
// ============================================
function processFileAsync(userId, messageId, fileName) {
  try {
    const blob = downloadFileFromLine(messageId);
    const file = saveFileToDrive(blob, fileName, userId);
    const text = extractTextFromPdf(file);

    if (!text || text.trim().length < 10) {
      pushMessage(userId, 'âš ï¸ ç„¡æ³•è®€å– PDF å…§å®¹ï¼Œå¯èƒ½æ˜¯æƒææª”æˆ–åœ–ç‰‡å‹ PDFã€‚');
      return;
    }
${config.knowledgeSheet ? `
    // æŸ¥è©¢çŸ¥è­˜åº«
    const knowledgeContext = searchKnowledge(text.substring(0, 200));` : ''}

    const feedback = generateOpenAIFeedback(text${config.knowledgeSheet ? ', knowledgeContext' : ''});
    logToSpreadsheet(userId, fileName, feedback);
    pushMessage(userId, 'âœ¨ ä½ çš„è‡ªä¸»å­¸ç¿’è©•èª âœ¨\\n\\n' + feedback + '\\n\\n---\\nğŸ“Œ ç¹¼çºŒåŠ æ²¹ï¼æœ‰æ–°çš„å­¸ç¿’æˆæœæ­¡è¿å†æ¬¡åˆ†äº«ï¼');

  } catch (error) {
    console.error('processFileAsync Error:', error);
    pushMessage(userId, 'âŒ è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
  }
}

// ============================================
// OpenAI API å‘¼å«
// ============================================
function generateOpenAIFeedback(pdfContent${config.knowledgeSheet ? ', knowledgeContext' : ''}) {
  const url = 'https://api.openai.com/v1/chat/completions';

  const maxLength = 8000;
  const truncatedContent = pdfContent.length > maxLength
    ? pdfContent.substring(0, maxLength) + '...(å…§å®¹å·²æˆªå–)'
    : pdfContent;

  const systemPrompt = \`${config.roleDescription}

ã€å›æ‡‰è¦æ±‚ã€‘
- èªè¨€ï¼š\${AI_CONFIG.language}
- èªæ°£é¢¨æ ¼ï¼š\${AI_CONFIG.tone}
- å­—æ•¸ï¼š\${AI_CONFIG.feedbackLength} å­—
- æ ¼å¼ï¼š${formatMap[config.responseFormat]}

ã€è©•èªçµæ§‹ã€‘
1. é«˜åº¦è‚¯å®šå­¸ç”Ÿçš„åŠªåŠ›å’Œäº®é»
2. å…·é«”åˆ†æä½œå“çš„å„ªé»æˆ–é€²æ­¥
3. çµ¦äºˆæœªä¾†å­¸ç¿’çš„å»ºè­°\`;

  const userPrompt = 'è«‹æ ¹æ“šä»¥ä¸‹å­¸ç”Ÿçš„è‡ªä¸»å­¸ç¿’æˆæœæ’°å¯«è©•èªï¼š\\n\\n' + truncatedContent${config.knowledgeSheet ? " + (knowledgeContext || '')" : ''};

  const payload = {
    model: MODEL_NAME,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ],
    max_tokens: parseInt(AI_CONFIG.maxTokens),
    temperature: parseFloat(AI_CONFIG.temperature)
  };

  const options = {
    method: 'post',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + OPENAI_API_KEY
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);
  const result = JSON.parse(response.getContentText());

  if (result.choices && result.choices[0]) {
    return result.choices[0].message.content.trim();
  } else {
    throw new Error('OpenAI API å›å‚³ç•°å¸¸ï¼š' + JSON.stringify(result));
  }
}
${knowledgeCode}

// ============================================
// LINE API å‡½å¼
// ============================================
function downloadFileFromLine(messageId) {
  const url = 'https://api-data.line.me/v2/bot/message/' + messageId + '/content';
  const response = UrlFetchApp.fetch(url, {
    headers: { 'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN }
  });
  return response.getBlob();
}

function replyMessage(replyToken, message) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN },
    payload: JSON.stringify({
      replyToken: replyToken,
      messages: [{ type: 'text', text: message }]
    })
  });
}

function pushMessage(userId, message) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN },
    payload: JSON.stringify({
      to: userId,
      messages: [{ type: 'text', text: message }]
    })
  });
}

// ============================================
// Google Drive å‡½å¼
// ============================================
function saveFileToDrive(blob, fileName, userId) {
  const folder = DriveApp.getFolderById(GOOGLE_DRIVE_FOLDER_ID);
  const timestamp = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyyMMdd_HHmmss');
  const newFileName = timestamp + '_' + userId.substring(0, 8) + '_' + fileName;
  blob.setName(newFileName);
  return folder.createFile(blob);
}

function extractTextFromPdf(file) {
  try {
    const resource = {
      title: 'temp_pdf_' + Date.now(),
      mimeType: 'application/vnd.google-apps.document'
    };
    const docFile = Drive.Files.insert(resource, file.getBlob(), { convert: true });
    const text = DocumentApp.openById(docFile.id).getBody().getText();
    DriveApp.getFileById(docFile.id).setTrashed(true);
    return text;
  } catch (error) {
    console.error('PDF è½‰æ›å¤±æ•—ï¼š' + error.message);
    return '';
  }
}

// ============================================
// è©¦ç®—è¡¨è¨˜éŒ„
// ============================================
function logToSpreadsheet(userId, fileName, feedback) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('è©•èªè¨˜éŒ„');

    if (!sheet) {
      sheet = spreadsheet.insertSheet('è©•èªè¨˜éŒ„');
      sheet.getRange(1, 1, 1, 5).setValues([['æ™‚é–“', 'ä½¿ç”¨è€…ID', 'æª”æ¡ˆåç¨±', 'è©•èª', 'æ¨¡å‹']]);
      sheet.getRange(1, 1, 1, 5).setFontWeight('bold');
    }

    const timestamp = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy/MM/dd HH:mm:ss');
    sheet.appendRow([timestamp, userId.substring(0, 10) + '***', fileName, feedback, MODEL_NAME]);
  } catch (error) {
    console.error('logToSpreadsheet Error:', error);
  }
}

// ============================================
// ä½¿ç”¨è€…ç‹€æ…‹ç®¡ç†
// ============================================
function setUserState(userId, state) {
  userProperties.setProperty('state_' + userId, state);
}

function getUserState(userId) {
  return userProperties.getProperty('state_' + userId) || '';
}

function clearUserState(userId) {
  userProperties.deleteProperty('state_' + userId);
}

// ============================================
// æ¸¬è©¦å‡½å¼
// ============================================
function testBot() {
  console.log('===== Bot è¨­å®šæ¸¬è©¦ =====');
  console.log('LINE Token é•·åº¦:', LINE_CHANNEL_ACCESS_TOKEN.length);
  console.log('OpenAI Key é•·åº¦:', OPENAI_API_KEY.length);
  console.log('Drive Folder ID:', GOOGLE_DRIVE_FOLDER_ID);
  console.log('Spreadsheet ID:', SPREADSHEET_ID);
  console.log('ä½¿ç”¨æ¨¡å‹:', MODEL_NAME);
  console.log('Temperature:', AI_CONFIG.temperature);
  console.log('æ¸¬è©¦å®Œæˆï¼');
}

function testOpenAIAPI() {
  const testContent = 'é€™æ˜¯ä¸€ä»½é—œæ–¼ç’°å¢ƒä¿è­·çš„è‡ªä¸»å­¸ç¿’å ±å‘Šã€‚å­¸ç”Ÿç ”ç©¶äº†æ°£å€™è®Šé·çš„å½±éŸ¿ï¼Œä¸¦æå‡ºäº†æ¸›å°‘ç¢³æ’æ”¾çš„å»ºè­°ã€‚å ±å‘Šå…§å®¹è©³å¯¦ï¼ŒåŒ…å«æ•¸æ“šåˆ†æå’Œåœ–è¡¨èªªæ˜ã€‚';
  console.log('æ¸¬è©¦ OpenAI API...');
  try {
    const feedback = generateOpenAIFeedback(testContent${config.knowledgeSheet ? ", ''" : ''});
    console.log('âœ… OpenAI API æˆåŠŸï¼');
    console.log('ç”Ÿæˆçš„è©•èªï¼š\\n' + feedback);
  } catch (error) {
    console.log('âŒ OpenAI API å¤±æ•—ï¼š' + error.message);
  }
}
`;
        }

        function copyCode() {
            const code = document.getElementById('codeContent').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btns = document.querySelectorAll('.code-btn');
                btns[0].textContent = 'å·²è¤‡è£½ï¼';
                btns[0].classList.add('copied');
                setTimeout(() => {
                    btns[0].textContent = 'è¤‡è£½ç¨‹å¼ç¢¼';
                    btns[0].classList.remove('copied');
                }, 2000);
            });
        }

        function downloadCode() {
            const code = document.getElementById('codeContent').textContent;
            const model = document.getElementById('modelSelect').value;
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'LINE_AI_Bot_' + model.replace(/[^a-zA-Z0-9]/g, '_') + '.gs';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
