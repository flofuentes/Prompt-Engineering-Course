<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©•é‡ç¶²ç«™ç¨‹å¼ç”Ÿæˆå™¨ - Part 7</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0c1445 0%, #1a237e 50%, #283593 100%);
            min-height: 100vh;
            color: #333;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image:
                radial-gradient(2px 2px at 20px 30px, white, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, white, transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent);
            background-size: 550px 250px;
            animation: twinkle 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: rgba(26, 35, 126, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 10000;
        }

        .nav-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, #ff9800, #ffb74d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-buttons { display: flex; gap: 12px; }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 152, 0, 0.3);
            border-color: #ff9800;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 100px 20px 40px;
            position: relative;
            z-index: 1;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 40px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(135deg, #6a1b9a, #e65100);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }

        h2 {
            color: #6a1b9a;
            font-size: 20px;
            margin: 30px 0 20px;
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, #6a1b9a, #e65100) 1;
            padding-bottom: 10px;
        }

        h2:first-of-type {
            margin-top: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-weight: 600;
            color: #6a1b9a;
            margin-bottom: 8px;
            font-size: 14px;
        }

        label .required {
            color: #c62828;
        }

        label .hint {
            font-weight: normal;
            color: #666;
            font-size: 12px;
            display: block;
            margin-top: 2px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #6a1b9a;
            box-shadow: 0 0 10px rgba(106, 27, 154, 0.2);
        }

        select {
            cursor: pointer;
            background: white;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .range-group input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            -webkit-appearance: none;
        }

        .range-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a1b9a, #e65100);
            cursor: pointer;
        }

        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: #6a1b9a;
        }

        /* éƒ¨ç½²æ–¹å¼é¸æ“‡ */
        .deploy-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .deploy-tab {
            flex: 1;
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
            position: relative;
        }

        .deploy-tab:hover {
            border-color: #6a1b9a;
        }

        .deploy-tab.active {
            border-color: #6a1b9a;
            background: linear-gradient(135deg, #f3e5f5, #ede7f6);
        }

        .deploy-tab .tab-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .deploy-tab .tab-name {
            font-weight: 700;
            color: #333;
            font-size: 18px;
        }

        .deploy-tab .tab-desc {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            line-height: 1.5;
        }

        .deploy-tab .tab-badge {
            position: absolute;
            top: -8px;
            right: 15px;
            background: #4caf50;
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .deploy-tab .tab-badge.recommend {
            background: linear-gradient(135deg, #ff6f00, #ff8f00);
        }

        /* AI æœå‹™é¸æ“‡ */
        .provider-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .provider-tab {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }

        .provider-tab:hover {
            border-color: #6a1b9a;
        }

        .provider-tab.active {
            border-color: #6a1b9a;
            background: linear-gradient(135deg, #f3e5f5, #ede7f6);
        }

        .provider-tab .tab-name {
            font-weight: 700;
            color: #6a1b9a;
            font-size: 16px;
        }

        .provider-tab .tab-desc {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .provider-tab .tab-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6a1b9a, #8e24aa);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(106, 27, 154, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6f00, #ff8f00);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 111, 0, 0.4);
        }

        .btn-outline {
            background: white;
            color: #6a1b9a;
            border: 2px solid #6a1b9a;
        }

        .btn-outline:hover {
            background: #f3e5f5;
        }

        /* ç¨‹å¼ç¢¼è¼¸å‡ºå€ */
        .output-section {
            display: none;
            margin-top: 40px;
        }

        .output-section.show {
            display: block;
        }

        .output-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .output-tab {
            padding: 12px 25px;
            border: none;
            background: #e0e0e0;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .output-tab.active {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            color: white;
        }

        .code-output {
            background: linear-gradient(135deg, #0c1445, #1a237e);
            border-radius: 0 15px 15px 15px;
            padding: 25px;
            position: relative;
            display: none;
        }

        .code-output.show {
            display: block;
        }

        .code-output pre {
            color: #b3e5fc;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }

        .code-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .code-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .code-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .code-btn.copied {
            background: #4caf50;
            border-color: #4caf50;
        }

        /* éƒ¨ç½²æŒ‡å— */
        .deploy-guide {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            display: none;
        }

        .deploy-guide.show {
            display: block;
        }

        .deploy-guide h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .deploy-steps {
            display: grid;
            gap: 12px;
        }

        .deploy-step {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            background: white;
            padding: 15px;
            border-radius: 10px;
        }

        .step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content strong {
            color: #1b5e20;
        }

        .step-content p {
            margin: 0;
            font-size: 14px;
            color: #333;
        }

        .step-content a {
            color: #1976d2;
        }

        /* æç¤ºæ¡† */
        .info-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #1976d2;
            padding: 15px 20px;
            border-radius: 0 10px 10px 0;
            margin: 15px 0;
        }

        .info-box h4 {
            color: #1565c0;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box p, .info-box li {
            font-size: 13px;
            color: #444;
        }

        .warning-box {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left: 4px solid #ff9800;
            padding: 15px 20px;
            border-radius: 0 10px 10px 0;
            margin: 15px 0;
        }

        .warning-box h4 {
            color: #e65100;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .warning-box p {
            font-size: 13px;
        }

        .footer-info {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .container { padding: 80px 15px 30px; }
            .main-card { padding: 25px; }
            h1 { font-size: 24px; }
            .form-row { grid-template-columns: 1fr; }
            .deploy-tabs { flex-direction: column; }
            .provider-tabs { flex-direction: column; }
            .btn { padding: 12px 25px; font-size: 14px; }
            .output-tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <span class="nav-title">è©•é‡ç¶²ç«™ç¨‹å¼ç”Ÿæˆå™¨</span>
        <div class="nav-buttons">
            <a href="index2.html" class="nav-btn">é¦–é </a>
            <a href="Part7-4_è©•é‡ç¶²ç«™å¯¦ä½œ.html" class="nav-btn">è¿”å›æ•™å­¸</a>
            <button class="nav-btn" onclick="toggleFullscreen()">å…¨è¢å¹•</button>
            <a href="https://www.youtube.com/@Liang-yt02" target="_blank" class="nav-btn">YT</a>
            <a href="https://www.facebook.com/?locale=zh_TW" target="_blank" class="nav-btn">FB</a>
            <a href="https://www.facebook.com/groups/2754139931432955?locale=zh_TW" target="_blank" class="nav-btn">3A</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-card">
            <h1>è©•é‡ç¶²ç«™ç¨‹å¼ç”Ÿæˆå™¨</h1>
            <p class="subtitle">é¸æ“‡éƒ¨ç½²æ–¹å¼ã€å¡«å…¥è¨­å®šï¼Œè‡ªå‹•ç”Ÿæˆä¸»ç¨‹å¼èˆ‡ GAS ç¨‹å¼ç¢¼</p>

            <div class="warning-box">
                <h4>å®‰å…¨æé†’</h4>
                <p>æ­¤å·¥å…·ä¸æœƒå„²å­˜æˆ–å‚³é€æ‚¨çš„ API Keyï¼Œæ‰€æœ‰è™•ç†éƒ½åœ¨ç€è¦½å™¨æœ¬åœ°é€²è¡Œã€‚è«‹å‹¿å°‡ API Key åˆ†äº«çµ¦ä»–äººã€‚</p>
            </div>

            <!-- æ­¥é©Ÿä¸€ï¼šé¸æ“‡éƒ¨ç½²æ–¹å¼ -->
            <h2>æ­¥é©Ÿä¸€ï¼šé¸æ“‡å‰ç«¯éƒ¨ç½²æ–¹å¼</h2>
            <div class="info-box">
                <h4>èªªæ˜</h4>
                <p>GASï¼ˆå¾Œç«¯ï¼‰ç¨‹å¼ç¢¼ä¸ç®¡é¸æ“‡å“ªç¨®å‰ç«¯éƒ¨ç½²æ–¹å¼éƒ½ç›¸åŒï¼Œéƒ½éœ€è¦éƒ¨ç½² GAS ä¸¦å–å¾—ç¶²å€ã€‚</p>
            </div>
            <div class="deploy-tabs">
                <div class="deploy-tab active" data-deploy="netlify" onclick="selectDeploy('netlify')">
                    <span class="tab-badge recommend">æ¨è–¦</span>
                    <div class="tab-icon">ğŸŒ</div>
                    <div class="tab-name">Netlify éƒ¨ç½²</div>
                    <div class="tab-desc">ä¸‹è¼‰ HTML æª”æ¡ˆï¼Œæ‹–æ›³ä¸Šå‚³è‡³ Netlify<br>è¼‰å…¥å¿«ã€ç¶²å€çŸ­ã€å…è²»ä½¿ç”¨</div>
                </div>
                <div class="deploy-tab" data-deploy="gemini-canvas" onclick="selectDeploy('gemini-canvas')">
                    <span class="tab-badge">å…éƒ¨ç½²</span>
                    <div class="tab-icon">âœ¨</div>
                    <div class="tab-name">Gemini Canvas</div>
                    <div class="tab-desc">ç›´æ¥åœ¨ Gemini å°è©±ä¸­åŸ·è¡Œ<br>ç„¡éœ€é¡å¤–éƒ¨ç½²ã€å³æ™‚é è¦½</div>
                </div>
            </div>

            <!-- æ­¥é©ŸäºŒï¼šåŸºæœ¬è¨­å®š -->
            <h2>æ­¥é©ŸäºŒï¼šåŸºæœ¬è¨­å®š</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Google è©¦ç®—è¡¨ ID <span class="required">*</span>
                        <span class="hint">ç”¨æ–¼è¨˜éŒ„è©•èªï¼Œç¶²å€ä¸­ /d/ å’Œ /edit ä¹‹é–“çš„å­—ä¸²</span>
                    </label>
                    <input type="text" id="spreadsheetId" placeholder="ä¾‹å¦‚ï¼š1w5OjdXzs8NmGL...">
                </div>
                <div class="form-group">
                    <label>æ•™å¸«é€šçŸ¥ Email
                        <span class="hint">å¯é¸ï¼Œæœ‰æ–°ä½œå“æ™‚ç™¼é€é€šçŸ¥</span>
                    </label>
                    <input type="text" id="teacherEmail" placeholder="ä¾‹å¦‚ï¼šteacher@school.edu.tw">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ç®¡ç†å¾Œå°å¯†ç¢¼ <span class="required">*</span>
                        <span class="hint">æ•™å¸«ç™»å…¥ç®¡ç†å¾Œå°ä½¿ç”¨</span>
                    </label>
                    <input type="text" id="adminPassword" placeholder="ä¾‹å¦‚ï¼šteacher123" value="0207">
                </div>
                <div class="form-group" id="gasUrlGroup">
                    <label>GAS éƒ¨ç½²ç¶²å€ <span class="required">*</span>
                        <span class="hint">éƒ¨ç½² GAS å¾Œç«¯ç¨‹å¼å¾Œå–å¾—çš„ç¶²å€ï¼ˆå¿…å¡«ï¼‰</span>
                    </label>
                    <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/...">
                </div>
            </div>

            <!-- æ­¥é©Ÿä¸‰ï¼šAI æœå‹™è¨­å®š -->
            <h2>æ­¥é©Ÿä¸‰ï¼šAI æœå‹™è¨­å®š</h2>
            <div class="provider-tabs">
                <div class="provider-tab active" data-provider="gemini" onclick="selectProvider('gemini')">
                    <div class="tab-name">Google Gemini <span class="tab-badge">å…è²»</span></div>
                    <div class="tab-desc">å…è²»é¡åº¦å¤šï¼Œé©åˆæ•™è‚²ä½¿ç”¨</div>
                </div>
                <div class="provider-tab" data-provider="openai" onclick="selectProvider('openai')">
                    <div class="tab-name">OpenAI GPT</div>
                    <div class="tab-desc">å“è³ªç©©å®šï¼Œéœ€ä»˜è²» API</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" id="geminiKeyGroup">
                    <label>Gemini API Key <span class="required">*</span>
                        <span class="hint">å¾ <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a> å–å¾—</span>
                    </label>
                    <input type="password" id="geminiApiKey" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Gemini API Key">
                </div>
                <div class="form-group" id="openaiKeyGroup" style="display: none;">
                    <label>OpenAI API Key <span class="required">*</span>
                        <span class="hint">å¾ <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a> å–å¾—</span>
                    </label>
                    <input type="password" id="openaiApiKey" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ OpenAI API Key">
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹ç‰ˆæœ¬ <span class="required">*</span></label>
                    <select id="modelSelect">
                        <optgroup label="Gemini æ¨¡å‹" id="geminiModels">
                            <option value="gemini-2.5-flash" selected>gemini-2.5-flashï¼ˆæ¨è–¦ï¼Œå¿«é€Ÿç©©å®šï¼‰</option>
                            <option value="gemini-2.5-pro">gemini-2.5-proï¼ˆé€²éšç‰ˆæœ¬ï¼‰</option>
                            <option value="gemini-3.0-flash">gemini-3.0-flashï¼ˆæœ€æ–°å¿«é€Ÿï¼‰</option>
                            <option value="gemini-3.0-pro">gemini-3.0-proï¼ˆæœ€æ–°é€²éšï¼‰</option>
                        </optgroup>
                        <optgroup label="OpenAI æ¨¡å‹" id="openaiModels" style="display: none;">
                            <option value="gpt-4o">gpt-4oï¼ˆæ¨è–¦ï¼Œæ€§åƒ¹æ¯”é«˜ï¼‰</option>
                            <option value="gpt-4.1">gpt-4.1ï¼ˆé€²éšç‰ˆæœ¬ï¼‰</option>
                            <option value="gpt-4-turbo">gpt-4-turboï¼ˆé«˜é€Ÿï¼‰</option>
                            <option value="gpt-5.1">gpt-5.1ï¼ˆæœ€æ–°æœ€å¼·ï¼‰</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <!-- æ­¥é©Ÿå››ï¼šè©•èªé¢¨æ ¼è¨­å®š -->
            <h2>æ­¥é©Ÿå››ï¼šè©•èªé¢¨æ ¼è¨­å®š</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>èªæ°£é¢¨æ ¼</label>
                    <select id="toneStyle">
                        <option value="warm" selected>æº«æš–ã€é¼“å‹µã€æ­£å‘</option>
                        <option value="friendly">å‹å–„ã€è‡ªç„¶ã€è¦ªåˆ‡</option>
                        <option value="professional">å°ˆæ¥­ã€å­¸è¡“ã€æ­£å¼</option>
                        <option value="humorous">å¹½é»˜ã€æ´»æ½‘ã€è¼•é¬†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è©•èªé•·åº¦</label>
                    <select id="feedbackLength">
                        <option value="50-80">50-80 å­—ï¼ˆç°¡çŸ­ï¼‰</option>
                        <option value="80-120" selected>80-120 å­—ï¼ˆé©ä¸­ï¼‰</option>
                        <option value="120-180">120-180 å­—ï¼ˆè©³ç´°ï¼‰</option>
                    </select>
                </div>
            </div>
            <div class="form-group full-width">
                <label>è§’è‰²å®šä½
                    <span class="hint">æè¿° AI è©•èªåŠ©æ‰‹çš„èº«ä»½å’Œé¢¨æ ¼</span>
                </label>
                <textarea id="roleDescription" rows="2" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä½æº«æš–çš„æ•™å¸«ï¼Œæ“…é•·ç™¼ç¾å­¸ç”Ÿä½œå“çš„äº®é»...">ä½ æ˜¯ä¸€ä½æº«æš–çš„æ•™å¸«ï¼Œæ“…é•·æ ¹æ“šå­¸ç”Ÿçš„ä½œå“çµ¦äºˆæ­£å‘ã€å…·é«”çš„å›é¥‹ã€‚è«‹ç”¨é¼“å‹µçš„èªæ°£ï¼Œç™¼ç¾ä½œå“çš„äº®é»ï¼Œä¸¦çµ¦äºˆå»ºè¨­æ€§çš„å»ºè­°ã€‚</textarea>
            </div>

            <!-- æ­¥é©Ÿäº”ï¼šé€²éšåƒæ•¸ -->
            <h2>æ­¥é©Ÿäº”ï¼šé€²éšåƒæ•¸ï¼ˆå¯é¸ï¼‰</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Temperatureï¼ˆå‰µæ„åº¦ï¼‰
                        <span class="hint">0 = ç©©å®šä¸€è‡´ï¼Œ1 = å‰µæ„å¤šè®Š</span>
                    </label>
                    <div class="range-group">
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" oninput="updateRangeValue('temperature')">
                        <span class="range-value" id="temperatureValue">0.7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>æœ€å¤§å›æ‡‰é•·åº¦ï¼ˆTokenï¼‰</label>
                    <select id="maxTokens">
                        <option value="500">500ï¼ˆç°¡çŸ­ï¼‰</option>
                        <option value="1000" selected>1000ï¼ˆæ¨™æº–ï¼‰</option>
                        <option value="2000">2000ï¼ˆè©³ç´°ï¼‰</option>
                    </select>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="generateCode()">ç”Ÿæˆç¨‹å¼ç¢¼</button>
                <button class="btn btn-outline" onclick="resetForm()">é‡è¨­è¡¨å–®</button>
            </div>

            <!-- ç¨‹å¼ç¢¼è¼¸å‡ºå€ -->
            <div class="output-section" id="outputSection">
                <h2>ç”Ÿæˆçš„ç¨‹å¼ç¢¼</h2>

                <div class="output-tabs">
                    <button class="output-tab active" onclick="showCodeTab('main')">ä¸»ç¨‹å¼ (HTML)</button>
                    <button class="output-tab" onclick="showCodeTab('gas')">GAS ç¨‹å¼ç¢¼</button>
                </div>

                <div class="code-output show" id="mainCodeOutput">
                    <div class="code-actions">
                        <button class="code-btn" onclick="copyCode('main')">è¤‡è£½ç¨‹å¼ç¢¼</button>
                        <button class="code-btn" onclick="downloadCode('main')">ä¸‹è¼‰ HTML</button>
                    </div>
                    <pre id="mainCodeContent"></pre>
                </div>

                <div class="code-output" id="gasCodeOutput">
                    <div class="code-actions">
                        <button class="code-btn" onclick="copyCode('gas')">è¤‡è£½ç¨‹å¼ç¢¼</button>
                        <button class="code-btn" onclick="downloadCode('gas')">ä¸‹è¼‰ .gs æª”æ¡ˆ</button>
                    </div>
                    <pre id="gasCodeContent"></pre>
                </div>
            </div>

            <!-- éƒ¨ç½²æŒ‡å— -->
            <div class="deploy-guide" id="deployGuide">
                <h3 id="deployGuideTitle">Netlify éƒ¨ç½²æ­¥é©Ÿ</h3>
                <div class="deploy-steps" id="deploySteps">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <div class="footer-info">
            &copy; 2026 é˜¿äº®è€å¸« | AI æ™ºæ…§æ•™å­¸å¯¦æˆ°å·¥ä½œåŠ
        </div>
    </div>

    <script>
        let selectedDeploy = 'netlify';
        let selectedProvider = 'gemini';

        function selectDeploy(deploy) {
            selectedDeploy = deploy;
            document.querySelectorAll('.deploy-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.deploy === deploy);
            });
            // GAS URL æ¬„ä½å§‹çµ‚é¡¯ç¤ºï¼Œå› ç‚ºä»»ä½•éƒ¨ç½²æ–¹å¼éƒ½éœ€è¦ GAS å¾Œç«¯
        }

        function selectProvider(provider) {
            selectedProvider = provider;
            document.querySelectorAll('.provider-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.provider === provider);
            });

            const geminiKeyGroup = document.getElementById('geminiKeyGroup');
            const openaiKeyGroup = document.getElementById('openaiKeyGroup');
            const geminiModels = document.getElementById('geminiModels');
            const openaiModels = document.getElementById('openaiModels');
            const modelSelect = document.getElementById('modelSelect');

            if (provider === 'gemini') {
                geminiKeyGroup.style.display = 'block';
                openaiKeyGroup.style.display = 'none';
                geminiModels.style.display = 'block';
                openaiModels.style.display = 'none';
                modelSelect.value = 'gemini-2.5-flash';
            } else {
                geminiKeyGroup.style.display = 'none';
                openaiKeyGroup.style.display = 'block';
                geminiModels.style.display = 'none';
                openaiModels.style.display = 'block';
                modelSelect.value = 'gpt-4o';
            }
        }

        function updateRangeValue(id) {
            const value = document.getElementById(id).value;
            document.getElementById(id + 'Value').textContent = value;
        }

        function resetForm() {
            document.querySelectorAll('input[type="text"], input[type="password"]').forEach(input => {
                if (input.id !== 'adminPassword') {
                    input.value = '';
                }
            });
            document.getElementById('temperature').value = 0.7;
            updateRangeValue('temperature');
            document.getElementById('outputSection').classList.remove('show');
            document.getElementById('deployGuide').classList.remove('show');
        }

        function showCodeTab(type) {
            document.querySelectorAll('.output-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.code-output').forEach(output => output.classList.remove('show'));

            if (type === 'main') {
                document.querySelectorAll('.output-tab')[0].classList.add('active');
                document.getElementById('mainCodeOutput').classList.add('show');
            } else {
                document.querySelectorAll('.output-tab')[1].classList.add('active');
                document.getElementById('gasCodeOutput').classList.add('show');
            }
        }

        function generateCode() {
            const config = {
                spreadsheetId: document.getElementById('spreadsheetId').value.trim() || 'YOUR_SPREADSHEET_ID',
                teacherEmail: document.getElementById('teacherEmail').value.trim() || '',
                adminPassword: document.getElementById('adminPassword').value.trim() || '0207',
                gasUrl: document.getElementById('gasUrl').value.trim() || 'YOUR_GAS_URL',
                geminiApiKey: document.getElementById('geminiApiKey').value.trim() || 'YOUR_GEMINI_API_KEY',
                openaiApiKey: document.getElementById('openaiApiKey').value.trim() || 'YOUR_OPENAI_API_KEY',
                model: document.getElementById('modelSelect').value,
                toneStyle: document.getElementById('toneStyle').value,
                feedbackLength: document.getElementById('feedbackLength').value,
                roleDescription: document.getElementById('roleDescription').value.trim(),
                temperature: document.getElementById('temperature').value,
                maxTokens: document.getElementById('maxTokens').value
            };

            const toneMap = {
                'friendly': 'å‹å–„ã€è‡ªç„¶ã€è¦ªåˆ‡',
                'professional': 'å°ˆæ¥­ã€å­¸è¡“ã€æ­£å¼',
                'warm': 'æº«æš–ã€é¼“å‹µã€æ­£å‘',
                'humorous': 'å¹½é»˜ã€æ´»æ½‘ã€è¼•é¬†'
            };

            // ç”Ÿæˆä¸»ç¨‹å¼
            const mainCode = generateMainCode(config);
            document.getElementById('mainCodeContent').textContent = mainCode;

            // ç”Ÿæˆ GAS ç¨‹å¼ç¢¼
            const gasCode = selectedProvider === 'gemini'
                ? generateGeminiGAS(config, toneMap)
                : generateOpenAIGAS(config, toneMap);
            document.getElementById('gasCodeContent').textContent = gasCode;

            // é¡¯ç¤ºè¼¸å‡ºå€
            document.getElementById('outputSection').classList.add('show');

            // ç”Ÿæˆéƒ¨ç½²æŒ‡å—
            generateDeployGuide();
            document.getElementById('deployGuide').classList.add('show');

            // æ»¾å‹•åˆ°è¼¸å‡ºå€
            document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function generateMainCode(config) {
            const gasUrl = config.gasUrl;

            // Gemini Canvas ç‰ˆæœ¬ - è¼ƒç°¡åŒ–çš„æ ¼å¼ï¼Œé©åˆç›´æ¥è²¼åˆ° Gemini
            if (selectedDeploy === 'gemini-canvas') {
                return generateGeminiCanvasCode(config, gasUrl);
            }

            // Netlify ç‰ˆæœ¬ - å®Œæ•´ HTML æª”æ¡ˆ

            return `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿä½œå“è©•é‡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <style>
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fade-in 0.5s ease-out; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 font-sans">
    <div id="app"></div>
    <script>
        // === é…ç½®è¨­å®š ===
        const GAS_API_URL = "${gasUrl}";
        const ADMIN_PASSWORD = "${config.adminPassword}";

        // === æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ===
        let currentPage = 'home';
        let studentName = '';
        let content = '';
        let file = null;
        let isSubmitting = false;
        let submitStatus = null;
        let searchName = '';
        let searchResults = [];
        let isSearching = false;
        let adminPassword = '';
        let isAdminAuthenticated = false;
        let loginError = '';
        let playingId = null;

        // === æ¸²æŸ“å‡½æ•¸ ===
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = \`
                <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-indigo-100 h-16 flex items-center">
                    <div class="max-w-5xl mx-auto px-6 w-full flex justify-between items-center">
                        <div class="flex items-center gap-2 font-bold text-xl text-indigo-600 cursor-pointer" onclick="navigate('home')">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
                            å­¸ç”Ÿä½œå“è©•é‡ç³»çµ±
                        </div>
                        <div class="hidden md:flex gap-6">
                            <button onclick="navigate('home')" class="text-sm font-semibold transition-all hover:text-indigo-500 \${currentPage === 'home' ? 'text-indigo-600' : 'text-gray-400'}">ä½œå“ä¸Šå‚³</button>
                            <button onclick="navigate('query')" class="text-sm font-semibold transition-all hover:text-indigo-500 \${currentPage === 'query' ? 'text-indigo-600' : 'text-gray-400'}">è©•èªæŸ¥è©¢</button>
                            <button onclick="navigate('admin')" class="text-sm font-semibold transition-all hover:text-indigo-500 \${currentPage === 'admin' ? 'text-indigo-600' : 'text-gray-400'}">ç®¡ç†å¾Œå°</button>
                        </div>
                    </div>
                </nav>

                <main class="pt-8 pb-24 max-w-5xl mx-auto px-4">
                    \${currentPage === 'home' ? renderHome() : ''}
                    \${currentPage === 'query' ? renderQuery() : ''}
                    \${currentPage === 'admin' ? renderAdmin() : ''}
                </main>

                <!-- æ‰‹æ©Ÿå°èˆª -->
                <div class="md:hidden fixed bottom-6 left-6 right-6 h-16 bg-indigo-900 rounded-full flex justify-around items-center px-4 z-50 shadow-xl">
                    <button onclick="navigate('home')" class="text-white transition-opacity \${currentPage === 'home' ? 'opacity-100' : 'opacity-40'}">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                    <button onclick="navigate('query')" class="text-white transition-opacity \${currentPage === 'query' ? 'opacity-100' : 'opacity-40'}">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                    <button onclick="navigate('admin')" class="text-white transition-opacity \${currentPage === 'admin' ? 'opacity-100' : 'opacity-40'}">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </button>
                </div>
            \`;
        }

        function renderHome() {
            return \`
                <div class="max-w-2xl mx-auto space-y-8 animate-in">
                    <div class="text-center space-y-3">
                        <h1 class="text-4xl font-bold text-gray-900">ä½œå“æª”æ¡ˆç¹³äº¤ç³»çµ±</h1>
                        <p class="text-gray-500">å¡«å¯«å§“åä¸¦ä¸Šå‚³ä½œå“ï¼Œç³»çµ±å°‡è‡ªå‹•ç”Ÿæˆ AI è©•èª</p>
                    </div>

                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 space-y-6">
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                å­¸ç”Ÿå§“å
                            </label>
                            <input type="text" value="\${studentName}" oninput="studentName = this.value" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" class="w-full px-4 py-3 rounded-xl bg-gray-50 border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>

                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                                ä½œå“å…§å®¹æˆ–æè¿°
                            </label>
                            <textarea rows="5" oninput="content = this.value" placeholder="è«‹ç°¡è¿°æ‚¨çš„ä½œå“å…§å®¹..." class="w-full px-4 py-3 rounded-xl bg-gray-50 border-none focus:ring-2 focus:ring-indigo-500 resize-none outline-none">\${content}</textarea>
                        </div>

                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                ä¸Šå‚³ä½œå“æª”æ¡ˆï¼ˆå¯é¸ï¼‰
                            </label>
                            <input type="file" onchange="file = this.files[0]; render();" class="w-full px-4 py-3 rounded-xl bg-indigo-50 border-2 border-dashed border-indigo-200 cursor-pointer">
                            \${file ? '<p class="text-sm text-indigo-600">å·²é¸æ“‡ï¼š' + file.name + '</p>' : ''}
                        </div>

                        <button onclick="submitWork()" \${isSubmitting || !studentName || !content ? 'disabled' : ''} class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 text-white font-semibold py-4 rounded-xl flex items-center justify-center gap-2 transition-all">
                            \${isSubmitting ? '<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>' : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>'}
                            \${isSubmitting ? 'æ­£åœ¨æäº¤ä¸­...' : 'ç¢ºèªæäº¤ä½œå“'}
                        </button>

                        \${submitStatus ? '<div class="p-4 rounded-xl text-center font-semibold ' + (submitStatus.includes('å¤±æ•—') || submitStatus.includes('éŒ¯èª¤') ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600') + '">' + submitStatus + '</div>' : ''}
                    </div>
                </div>
            \`;
        }

        function renderQuery() {
            return \`
                <div class="max-w-3xl mx-auto space-y-8 animate-in">
                    <div class="text-center space-y-2">
                        <h1 class="text-3xl font-bold text-gray-900">è©•èªèˆ‡æª”æ¡ˆæŸ¥è©¢</h1>
                        <p class="text-gray-500 text-sm">æŸ¥çœ‹ç¹³äº¤ç´€éŒ„èˆ‡è€å¸«çš„è©•èª</p>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-1">
                            <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="text" value="\${searchName}" oninput="searchName = this.value" onkeydown="if(event.key === 'Enter') queryReviews()" placeholder="è¼¸å…¥å§“åæœå°‹..." class="w-full pl-12 pr-4 py-4 rounded-2xl shadow-lg focus:ring-2 focus:ring-indigo-500 outline-none font-medium">
                        </div>
                        <button onclick="queryReviews()" \${isSearching ? 'disabled' : ''} class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-semibold shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-2">
                            \${isSearching ? '<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>' : ''}
                            æœå°‹ç´€éŒ„
                        </button>
                    </div>

                    <div class="space-y-6">
                        \${searchResults.length > 0 ? searchResults.map((item, index) => \`
                            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden hover:border-indigo-100 transition-colors">
                                <div class="p-6 md:p-8 md:flex gap-8">
                                    <div class="flex-1 space-y-4">
                                        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                                            <div>
                                                <p class="text-xs font-medium text-indigo-400">\${new Date(item.time).toLocaleString('zh-TW')}</p>
                                                <h3 class="text-xl font-bold text-gray-800">\${item.name} åŒå­¸</h3>
                                            </div>
                                            <div class="px-4 py-2 rounded-xl bg-gradient-to-br from-purple-600 to-indigo-700 text-white font-bold tracking-wider shadow">
                                                \${item.fourCharComment}
                                            </div>
                                        </div>
                                        <div class="bg-gray-50 p-4 rounded-xl border-l-4 border-indigo-500">
                                            <p class="text-gray-700 leading-relaxed">\${item.feedback}</p>
                                        </div>
                                        \${item.fileUrl ? '<a href="' + item.fileUrl + '" target="_blank" class="inline-flex items-center gap-2 text-indigo-600 font-medium hover:bg-indigo-50 px-3 py-2 rounded-lg transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>æŸ¥çœ‹ç¹³äº¤æª”æ¡ˆ</a>' : ''}
                                    </div>
                                    <div class="flex flex-col items-center justify-center gap-2 border-t md:border-t-0 md:border-l border-gray-100 pt-4 md:pt-0 md:pl-6">
                                        <button onclick="handleSpeak('\${item.fourCharComment}ã€‚\${item.feedback}', \${index})" class="w-16 h-16 rounded-full flex items-center justify-center transition-all shadow-lg \${playingId === index ? 'bg-rose-500 text-white animate-pulse' : 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200'}">
                                            \${playingId === index ? '<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' : '<svg class="w-8 h-8 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'}
                                        </button>
                                        <span class="text-xs font-medium \${playingId === index ? 'text-rose-500' : 'text-gray-400'}">\${playingId === index ? 'æ­£åœ¨æœ—è®€' : 'èªéŸ³è©•èª'}</span>
                                    </div>
                                </div>
                            </div>
                        \`).join('') : (searchName && !isSearching ? '<div class="text-center py-16 text-gray-300 flex flex-col items-center gap-4"><svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p class="font-medium">æ‰¾ä¸åˆ°è©²å­¸ç”Ÿçš„ç´€éŒ„</p></div>' : '')}
                    </div>
                </div>
            \`;
        }

        function renderAdmin() {
            if (!isAdminAuthenticated) {
                return \`
                    <div class="max-w-md mx-auto mt-16 p-8 bg-white rounded-2xl shadow-xl space-y-6 animate-in">
                        <div class="text-center space-y-2">
                            <div class="w-14 h-14 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            </div>
                            <h2 class="text-2xl font-bold">ç®¡ç†ç™»å…¥</h2>
                        </div>
                        <div class="space-y-4">
                            <input type="password" value="\${adminPassword}" oninput="adminPassword = this.value" onkeydown="if(event.key === 'Enter') handleAdminLogin()" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full px-4 py-3 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500 font-medium">
                            <button onclick="handleAdminLogin()" class="w-full bg-indigo-900 text-white py-3 rounded-xl font-semibold shadow hover:bg-black transition-all">é€²å…¥ç®¡ç†å¾Œå°</button>
                            \${loginError ? '<p class="text-red-500 text-sm text-center font-medium">' + loginError + '</p>' : ''}
                        </div>
                    </div>
                \`;
            }

            return \`
                <div class="max-w-3xl mx-auto p-8 bg-white rounded-2xl shadow-xl text-center space-y-6 animate-in">
                    <h1 class="text-2xl font-bold text-gray-800">æ•™å¸«ç®¡ç†ä¸­å¿ƒ</h1>
                    <div class="grid gap-4">
                        <div class="p-6 bg-green-50 rounded-2xl border border-green-100">
                            <p class="text-green-700 font-medium mb-4">ç³»çµ±é€£æ¥æ­£å¸¸</p>
                            <a href="https://docs.google.com/spreadsheets/d/${config.spreadsheetId}" target="_blank" class="inline-block px-8 py-3 bg-white rounded-xl font-semibold text-indigo-700 shadow hover:shadow-lg transition-all">é–‹å•Ÿ Google è©¦ç®—è¡¨</a>
                        </div>
                        \${config.teacherEmail ? '<div class="p-6 bg-indigo-50 rounded-2xl border border-indigo-100"><p class="text-indigo-700 font-medium">é€šçŸ¥ Emailï¼š' + config.teacherEmail + '</p></div>' : ''}
                    </div>
                    <button onclick="isAdminAuthenticated = false; adminPassword = ''; render();" class="text-gray-400 hover:text-red-500 font-medium text-sm transition-colors">å®‰å…¨ç™»å‡º</button>
                </div>
            \`;
        }

        // === åŠŸèƒ½å‡½æ•¸ ===
        function navigate(page) {
            currentPage = page;
            render();
        }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function submitWork() {
            if (!studentName || !content) return;
            isSubmitting = true;
            submitStatus = 'æ­£åœ¨ä¸Šå‚³ä¸¦ç”± AI åˆ†æè©•èªï¼Œè«‹ç¨å€™...';
            render();

            let fileData = null, fileName = '', mimeType = '';
            if (file) {
                try {
                    fileData = await fileToBase64(file);
                    fileName = file.name;
                    mimeType = file.type;
                } catch (err) {
                    console.error('File error:', err);
                }
            }

            try {
                await fetch(GAS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'submit',
                        name: studentName,
                        content: content,
                        fileName: fileName,
                        fileData: fileData,
                        mimeType: mimeType
                    })
                });
                submitStatus = 'ä½œå“å·²æˆåŠŸé€å‡ºï¼AI è©•èªå°‡è¨˜éŒ„åœ¨è©¦ç®—è¡¨ä¸­ã€‚';
                studentName = '';
                content = '';
                file = null;
            } catch (error) {
                submitStatus = 'æäº¤éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°å˜—è©¦ã€‚';
            } finally {
                isSubmitting = false;
                render();
            }
        }

        async function queryReviews() {
            if (!searchName) return;
            isSearching = true;
            render();

            try {
                const response = await fetch(\`\${GAS_API_URL}?name=\${encodeURIComponent(searchName)}\`);
                const data = await response.json();
                searchResults = data;
            } catch (error) {
                console.error('Query error:', error);
                searchResults = [];
            } finally {
                isSearching = false;
                render();
            }
        }

        function handleAdminLogin() {
            if (adminPassword === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                loginError = '';
            } else {
                loginError = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚';
            }
            render();
        }

        function handleSpeak(text, id) {
            const synth = window.speechSynthesis;
            if (playingId === id) {
                synth.cancel();
                playingId = null;
                render();
                return;
            }
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.onend = () => { playingId = null; render(); };
            utterance.onstart = () => { playingId = id; render(); };
            synth.speak(utterance);
        }

        // åˆå§‹æ¸²æŸ“
        render();
    <\/script>
</body>
</html>`;
        }

        function generateGeminiCanvasCode(config, gasUrl) {
            return `<!-- ============================================
     Gemini Canvas ç‰ˆæœ¬ - å­¸ç”Ÿä½œå“è©•é‡ç³»çµ±
     ç›´æ¥è²¼åˆ° Gemini å°è©±ä¸­ä½¿ç”¨
     ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
============================================ -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿä½œå“è©•é‡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 p-4">
    <div id="app" class="max-w-2xl mx-auto"></div>
    <script>
        // ======== é…ç½®è¨­å®š ========
        const GAS_API_URL = "${gasUrl}";
        const ADMIN_PASSWORD = "${config.adminPassword}";

        // ======== ç‹€æ…‹ç®¡ç† ========
        let state = {
            page: 'home',
            name: '',
            content: '',
            file: null,
            loading: false,
            message: '',
            searchName: '',
            results: [],
            adminAuth: false
        };

        // ======== ä¸»è¦æ¸²æŸ“ ========
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = \`
                <nav class="flex gap-4 mb-8 bg-white p-4 rounded-2xl shadow">
                    <button onclick="state.page='home';render()" class="px-4 py-2 rounded-xl font-bold \${state.page==='home'?'bg-indigo-600 text-white':'bg-gray-100'}">ä½œå“ä¸Šå‚³</button>
                    <button onclick="state.page='query';render()" class="px-4 py-2 rounded-xl font-bold \${state.page==='query'?'bg-indigo-600 text-white':'bg-gray-100'}">è©•èªæŸ¥è©¢</button>
                    <button onclick="state.page='admin';render()" class="px-4 py-2 rounded-xl font-bold \${state.page==='admin'?'bg-indigo-600 text-white':'bg-gray-100'}">ç®¡ç†å¾Œå°</button>
                </nav>
                \${state.page === 'home' ? renderHome() : state.page === 'query' ? renderQuery() : renderAdmin()}
            \`;
        }

        function renderHome() {
            return \`
                <div class="bg-white p-8 rounded-2xl shadow-xl">
                    <h1 class="text-2xl font-bold text-center mb-6 text-indigo-600">ä½œå“ç¹³äº¤ç³»çµ±</h1>
                    <div class="space-y-4">
                        <input type="text" placeholder="å­¸ç”Ÿå§“å" value="\${state.name}" oninput="state.name=this.value"
                            class="w-full px-4 py-3 rounded-xl bg-gray-50 border-2 border-transparent focus:border-indigo-500 outline-none">
                        <textarea rows="5" placeholder="ä½œå“å…§å®¹æˆ–æè¿°" oninput="state.content=this.value"
                            class="w-full px-4 py-3 rounded-xl bg-gray-50 border-2 border-transparent focus:border-indigo-500 outline-none resize-none">\${state.content}</textarea>
                        <input type="file" onchange="state.file=this.files[0];render()"
                            class="w-full px-4 py-3 rounded-xl bg-indigo-50 border-2 border-dashed border-indigo-200">
                        \${state.file ? '<p class="text-indigo-600 text-sm">å·²é¸æ“‡ï¼š'+state.file.name+'</p>' : ''}
                        <button onclick="submitWork()" \${state.loading?'disabled':''}
                            class="w-full py-4 rounded-xl font-bold text-white \${state.loading?'bg-gray-400':'bg-indigo-600 hover:bg-indigo-700'}">
                            \${state.loading ? 'æäº¤ä¸­...' : 'ç¢ºèªæäº¤'}
                        </button>
                        \${state.message ? '<p class="text-center font-bold '+(state.message.includes('æˆåŠŸ')?'text-green-600':'text-red-600')+'">'+state.message+'</p>' : ''}
                    </div>
                </div>
            \`;
        }

        function renderQuery() {
            return \`
                <div class="bg-white p-8 rounded-2xl shadow-xl">
                    <h1 class="text-2xl font-bold text-center mb-6 text-indigo-600">è©•èªæŸ¥è©¢</h1>
                    <div class="flex gap-4 mb-6">
                        <input type="text" placeholder="è¼¸å…¥å§“åæœå°‹" value="\${state.searchName}"
                            oninput="state.searchName=this.value" onkeydown="if(event.key==='Enter')queryResults()"
                            class="flex-1 px-4 py-3 rounded-xl bg-gray-50 border-2 border-transparent focus:border-indigo-500 outline-none">
                        <button onclick="queryResults()" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">æœå°‹</button>
                    </div>
                    <div class="space-y-4">
                        \${state.results.map(r => \`
                            <div class="p-6 bg-gray-50 rounded-xl border-l-4 border-indigo-500">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <p class="text-xs text-gray-400">\${new Date(r.time).toLocaleString('zh-TW')}</p>
                                        <p class="font-bold text-lg">\${r.name} åŒå­¸</p>
                                    </div>
                                    <span class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold">\${r.fourCharComment}</span>
                                </div>
                                <p class="text-gray-700">\${r.feedback}</p>
                                \${r.fileUrl ? '<a href="'+r.fileUrl+'" target="_blank" class="inline-block mt-3 text-indigo-600 font-medium hover:underline">æŸ¥çœ‹é™„ä»¶</a>' : ''}
                            </div>
                        \`).join('') || (state.searchName && !state.loading ? '<p class="text-center text-gray-400">æ‰¾ä¸åˆ°ç´€éŒ„</p>' : '')}
                    </div>
                </div>
            \`;
        }

        function renderAdmin() {
            if (!state.adminAuth) {
                return \`
                    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md mx-auto">
                        <h2 class="text-xl font-bold text-center mb-6">ç®¡ç†ç™»å…¥</h2>
                        <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeydown="if(event.key==='Enter')adminLogin()"
                            class="w-full px-4 py-3 rounded-xl bg-gray-50 border-2 border-transparent focus:border-indigo-500 outline-none mb-4">
                        <button onclick="adminLogin()" class="w-full py-3 bg-indigo-900 text-white rounded-xl font-bold hover:bg-black">ç™»å…¥</button>
                    </div>
                \`;
            }
            return \`
                <div class="bg-white p-8 rounded-2xl shadow-xl text-center">
                    <h2 class="text-xl font-bold mb-6">æ•™å¸«ç®¡ç†ä¸­å¿ƒ</h2>
                    <div class="p-6 bg-green-50 rounded-xl mb-4">
                        <p class="text-green-700 mb-4">ç³»çµ±é€£æ¥æ­£å¸¸</p>
                        <a href="https://docs.google.com/spreadsheets/d/${config.spreadsheetId}" target="_blank"
                            class="px-6 py-3 bg-white rounded-xl font-bold text-indigo-700 shadow hover:shadow-lg inline-block">é–‹å•Ÿè©¦ç®—è¡¨</a>
                    </div>
                    <button onclick="state.adminAuth=false;render()" class="text-gray-400 hover:text-red-500">ç™»å‡º</button>
                </div>
            \`;
        }

        // ======== åŠŸèƒ½å‡½æ•¸ ========
        async function submitWork() {
            if (!state.name || !state.content) return alert('è«‹å¡«å¯«å§“åå’Œå…§å®¹');
            state.loading = true;
            state.message = 'æ­£åœ¨æäº¤...';
            render();

            let fileData = null, fileName = '', mimeType = '';
            if (state.file) {
                try {
                    fileData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(state.file);
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                    });
                    fileName = state.file.name;
                    mimeType = state.file.type;
                } catch (e) { console.error(e); }
            }

            try {
                await fetch(GAS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'submit', name: state.name, content: state.content, fileName, fileData, mimeType })
                });
                state.message = 'ä½œå“å·²æˆåŠŸé€å‡ºï¼';
                state.name = '';
                state.content = '';
                state.file = null;
            } catch (e) {
                state.message = 'æäº¤å¤±æ•—ï¼Œè«‹é‡è©¦';
            } finally {
                state.loading = false;
                render();
            }
        }

        async function queryResults() {
            if (!state.searchName) return;
            state.loading = true;
            render();
            try {
                const res = await fetch(\`\${GAS_API_URL}?name=\${encodeURIComponent(state.searchName)}\`);
                state.results = await res.json();
            } catch (e) {
                state.results = [];
            } finally {
                state.loading = false;
                render();
            }
        }

        function adminLogin() {
            const pwd = document.getElementById('adminPwd').value;
            if (pwd === ADMIN_PASSWORD) {
                state.adminAuth = true;
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤');
            }
            render();
        }

        render();
    <\/script>
</body>
</html>`;
        }

        function generateGeminiGAS(config, toneMap) {
            const emailCode = config.teacherEmail ? `
function sendNotificationEmail(name, content, review, fileBlob) {
  const subject = \`ã€æ–°ä½œå“ç¹³äº¤ã€‘å­¸ç”Ÿï¼š\${name}\`;
  const body = \`è€å¸«æ‚¨å¥½ï¼Œæœ‰å­¸ç”Ÿæäº¤äº†æ–°ä½œå“ï¼š\\n\\n\` +
               \`å­¸ç”Ÿå§“åï¼š\${name}\\n\` +
               \`ä½œå“å…§å®¹ï¼š\\n\${content}\\n\\n\` +
               \`AI è©•èªï¼š\${review.fourCharComment}\\n\` +
               \`AI å›é¥‹ï¼š\${review.feedback}\\n\\n\` +
               \`æª”æ¡ˆå·²å­˜å…¥ Google Drive èˆ‡è©¦ç®—è¡¨ä¸­ã€‚\`;

  const mailOptions = { to: TEACHER_EMAIL, subject: subject, body: body };
  if (fileBlob) mailOptions.attachments = [fileBlob];
  MailApp.sendEmail(mailOptions);
}` : '';

            return `// ============================================
// è©•é‡ç¶²ç«™ GAS ç¨‹å¼ç¢¼
// AI æœå‹™ï¼šGoogle Gemini
// æ¨¡å‹ï¼š${config.model}
// ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
// ============================================

// === è¨­å®šå€åŸŸ ===
const SPREADSHEET_ID = '${config.spreadsheetId}';
const GEMINI_API_KEY = '${config.geminiApiKey}';
const MODEL_NAME = '${config.model}';
${config.teacherEmail ? `const TEACHER_EMAIL = '${config.teacherEmail}';` : '// const TEACHER_EMAIL = \'\'; // æœªè¨­å®šé€šçŸ¥ Email'}

// AI å›æ‡‰è¨­å®š
const AI_CONFIG = {
  temperature: ${config.temperature},
  maxOutputTokens: ${config.maxTokens},
  tone: '${toneMap[config.toneStyle]}',
  feedbackLength: '${config.feedbackLength}',
  roleDescription: \`${config.roleDescription}\`
};

// ============================================
// ä¸»è¦å…¥å£é»
// ============================================
function doGet(e) {
  try {
    const name = e.parameter.name;
    if (!name) return createResponse({ error: 'Name required' });

    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheets()[0];
    const data = sheet.getDataRange().getValues();
    data.shift(); // ç§»é™¤æ¨™é¡Œåˆ—

    const results = data.filter(row => row[1] == name).map(row => ({
      time: row[0],
      name: row[1],
      feedback: row[4],
      fourCharComment: row[3],
      fileUrl: row[5]
    })).reverse();

    return createResponse(results);
  } catch (err) {
    return createResponse({ error: err.toString() });
  }
}

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const { name, content, fileName, fileData, mimeType } = params;

    // 1. å‘¼å« AI ç”Ÿæˆè©•èª
    const aiReview = getGeminiReview(content);

    // 2. è™•ç†æª”æ¡ˆä¸Šå‚³
    let fileUrl = "";
    let fileBlob = null;
    if (fileData) {
      fileBlob = Utilities.newBlob(Utilities.base64Decode(fileData), mimeType, fileName);
      const folder = getFolder("å­¸ç”Ÿä½œå“é™„ä»¶åº«");
      const file = folder.createFile(fileBlob);
      fileUrl = file.getUrl();
    }

    // 3. å¯«å…¥è©¦ç®—è¡¨
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheets()[0];
    sheet.appendRow([new Date(), name, content, aiReview.fourCharComment, aiReview.feedback, fileUrl]);

    // 4. ç™¼é€é€šçŸ¥ä¿¡ï¼ˆå¦‚æœæœ‰è¨­å®šï¼‰
    ${config.teacherEmail ? 'sendNotificationEmail(name, content, aiReview, fileBlob);' : '// sendNotificationEmail(name, content, aiReview, fileBlob);'}

    return createResponse({ status: 'success' });
  } catch (err) {
    return createResponse({ status: 'error', message: err.toString() });
  }
}

// ============================================
// Gemini API å‘¼å«
// ============================================
function getGeminiReview(text) {
  const url = \`https://generativelanguage.googleapis.com/v1beta/models/\${MODEL_NAME}:generateContent?key=\${GEMINI_API_KEY}\`;

  const prompt = \`\${AI_CONFIG.roleDescription}

ã€ä»»å‹™ã€‘
è«‹é‡å°å­¸ç”Ÿçš„ä½œå“çµ¦äºˆå›é¥‹ï¼Œèªæ°£ç‚ºã€Œ\${AI_CONFIG.tone}ã€ï¼Œå­—æ•¸ç´„ \${AI_CONFIG.feedbackLength} å­—ã€‚

ã€è¼¸å‡ºæ ¼å¼ã€‘
è«‹å‹™å¿…å›å‚³ç´” JSON æ ¼å¼ï¼š
{
  "fourCharComment": "å…«å€‹å­—çµ„æˆçš„çŸ­èªè©•èªï¼ˆä¾‹å¦‚ï¼šæ¢ç´¢æœªçŸ¥å‹‡æ–¼å˜—è©¦ï¼‰",
  "feedback": "è©³ç´°çš„æ–‡å­—å›é¥‹"
}

ã€å­¸ç”Ÿä½œå“å…§å®¹ã€‘
\${text}\`;

  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: {
        temperature: AI_CONFIG.temperature,
        maxOutputTokens: AI_CONFIG.maxOutputTokens,
        responseMimeType: "application/json"
      }
    }),
    muteHttpExceptions: true
  };

  try {
    const res = UrlFetchApp.fetch(url, options);
    const jsonStr = JSON.parse(res.getContentText()).candidates[0].content.parts[0].text;
    // å¼·åŒ–è§£æï¼šæå– JSON éƒ¨åˆ†
    const cleanJson = jsonStr.match(/\\{[\\s\\S]*\\}/)[0];
    return JSON.parse(cleanJson);
  } catch (e) {
    console.error('Gemini API Error:', e);
    return {
      fourCharComment: "ç”¨å¿ƒå¯«ä½œå€¼å¾—é¼“å‹µ",
      feedback: "è€å¸«æ”¶åˆ°äº†ä½ çš„ä½œå“ï¼Œå…§å®¹éå¸¸æœ‰æ„ç¾©ï¼Œè«‹ç¹¼çºŒä¿æŒé€™ä»½å‰µä½œçš„ç†±æƒ…ï¼"
    };
  }
}
${emailCode}

// ============================================
// è¼”åŠ©å‡½æ•¸
// ============================================
function getFolder(folderName) {
  const folders = DriveApp.getFoldersByName(folderName);
  return folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);
}

function createResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// ============================================
// æ¸¬è©¦èˆ‡æˆæ¬Š
// ============================================
function manualAuthTest() {
  Logger.log("æ­£åœ¨æ¸¬è©¦æ¬Šé™...");
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheets()[0];
  Logger.log("è©¦ç®—è¡¨è®€å–æˆåŠŸ: " + sheet.getName());
  ${config.teacherEmail ? `MailApp.sendEmail(TEACHER_EMAIL, "æ¬Šé™æ¸¬è©¦", "å¦‚æœæ‚¨æ”¶åˆ°é€™å°ä¿¡ï¼Œä»£è¡¨ GAS éƒµä»¶æ¬Šé™å·²é–‹å•Ÿã€‚");
  Logger.log("æ¸¬è©¦éƒµä»¶å·²ç™¼é€ã€‚");` : '// æœªè¨­å®š Emailï¼Œè·³ééƒµä»¶æ¸¬è©¦'}
  Logger.log("æ¸¬è©¦å®Œæˆï¼");
}

function testGeminiAPI() {
  const testContent = 'é€™æ˜¯ä¸€ä»½é—œæ–¼ç’°å¢ƒä¿è­·çš„å­¸ç¿’å ±å‘Šï¼Œå­¸ç”Ÿç ”ç©¶äº†æ°£å€™è®Šé·çš„å½±éŸ¿ã€‚';
  console.log('æ¸¬è©¦ Gemini API...');
  try {
    const feedback = getGeminiReview(testContent);
    console.log('Gemini API æˆåŠŸï¼');
    console.log('ç”Ÿæˆçš„è©•èªï¼š', JSON.stringify(feedback, null, 2));
  } catch (error) {
    console.log('Gemini API å¤±æ•—ï¼š' + error.message);
  }
}`;
        }

        function generateOpenAIGAS(config, toneMap) {
            const emailCode = config.teacherEmail ? `
function sendNotificationEmail(name, content, review, fileBlob) {
  const subject = \`ã€æ–°ä½œå“ç¹³äº¤ã€‘å­¸ç”Ÿï¼š\${name}\`;
  const body = \`è€å¸«æ‚¨å¥½ï¼Œæœ‰å­¸ç”Ÿæäº¤äº†æ–°ä½œå“ï¼š\\n\\n\` +
               \`å­¸ç”Ÿå§“åï¼š\${name}\\n\` +
               \`ä½œå“å…§å®¹ï¼š\\n\${content}\\n\\n\` +
               \`AI è©•èªï¼š\${review.fourCharComment}\\n\` +
               \`AI å›é¥‹ï¼š\${review.feedback}\\n\\n\` +
               \`æª”æ¡ˆå·²å­˜å…¥ Google Drive èˆ‡è©¦ç®—è¡¨ä¸­ã€‚\`;

  const mailOptions = { to: TEACHER_EMAIL, subject: subject, body: body };
  if (fileBlob) mailOptions.attachments = [fileBlob];
  MailApp.sendEmail(mailOptions);
}` : '';

            return `// ============================================
// è©•é‡ç¶²ç«™ GAS ç¨‹å¼ç¢¼
// AI æœå‹™ï¼šOpenAI GPT
// æ¨¡å‹ï¼š${config.model}
// ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
// ============================================

// === è¨­å®šå€åŸŸ ===
const SPREADSHEET_ID = '${config.spreadsheetId}';
const OPENAI_API_KEY = '${config.openaiApiKey}';
const MODEL_NAME = '${config.model}';
${config.teacherEmail ? `const TEACHER_EMAIL = '${config.teacherEmail}';` : '// const TEACHER_EMAIL = \'\'; // æœªè¨­å®šé€šçŸ¥ Email'}

// AI å›æ‡‰è¨­å®š
const AI_CONFIG = {
  temperature: ${config.temperature},
  maxTokens: ${config.maxTokens},
  tone: '${toneMap[config.toneStyle]}',
  feedbackLength: '${config.feedbackLength}',
  roleDescription: \`${config.roleDescription}\`
};

// ============================================
// ä¸»è¦å…¥å£é»
// ============================================
function doGet(e) {
  try {
    const name = e.parameter.name;
    if (!name) return createResponse({ error: 'Name required' });

    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheets()[0];
    const data = sheet.getDataRange().getValues();
    data.shift();

    const results = data.filter(row => row[1] == name).map(row => ({
      time: row[0],
      name: row[1],
      feedback: row[4],
      fourCharComment: row[3],
      fileUrl: row[5]
    })).reverse();

    return createResponse(results);
  } catch (err) {
    return createResponse({ error: err.toString() });
  }
}

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const { name, content, fileName, fileData, mimeType } = params;

    // 1. å‘¼å« AI ç”Ÿæˆè©•èª
    const aiReview = getOpenAIReview(content);

    // 2. è™•ç†æª”æ¡ˆä¸Šå‚³
    let fileUrl = "";
    let fileBlob = null;
    if (fileData) {
      fileBlob = Utilities.newBlob(Utilities.base64Decode(fileData), mimeType, fileName);
      const folder = getFolder("å­¸ç”Ÿä½œå“é™„ä»¶åº«");
      const file = folder.createFile(fileBlob);
      fileUrl = file.getUrl();
    }

    // 3. å¯«å…¥è©¦ç®—è¡¨
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheets()[0];
    sheet.appendRow([new Date(), name, content, aiReview.fourCharComment, aiReview.feedback, fileUrl]);

    // 4. ç™¼é€é€šçŸ¥ä¿¡
    ${config.teacherEmail ? 'sendNotificationEmail(name, content, aiReview, fileBlob);' : '// sendNotificationEmail(name, content, aiReview, fileBlob);'}

    return createResponse({ status: 'success' });
  } catch (err) {
    return createResponse({ status: 'error', message: err.toString() });
  }
}

// ============================================
// OpenAI API å‘¼å«
// ============================================
function getOpenAIReview(text) {
  const url = 'https://api.openai.com/v1/chat/completions';

  const systemPrompt = \`\${AI_CONFIG.roleDescription}

ã€ä»»å‹™ã€‘
è«‹é‡å°å­¸ç”Ÿçš„ä½œå“çµ¦äºˆå›é¥‹ï¼Œèªæ°£ç‚ºã€Œ\${AI_CONFIG.tone}ã€ï¼Œå­—æ•¸ç´„ \${AI_CONFIG.feedbackLength} å­—ã€‚

ã€è¼¸å‡ºæ ¼å¼ã€‘
è«‹å‹™å¿…å›å‚³ç´” JSON æ ¼å¼ï¼š
{
  "fourCharComment": "å…«å€‹å­—çµ„æˆçš„çŸ­èªè©•èªï¼ˆä¾‹å¦‚ï¼šæ¢ç´¢æœªçŸ¥å‹‡æ–¼å˜—è©¦ï¼‰",
  "feedback": "è©³ç´°çš„æ–‡å­—å›é¥‹"
}\`;

  const payload = {
    model: MODEL_NAME,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: 'è«‹æ ¹æ“šä»¥ä¸‹å­¸ç”Ÿä½œå“çµ¦äºˆè©•èªï¼š\\n\\n' + text }
    ],
    max_tokens: parseInt(AI_CONFIG.maxTokens),
    temperature: parseFloat(AI_CONFIG.temperature),
    response_format: { type: "json_object" }
  };

  const options = {
    method: 'post',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + OPENAI_API_KEY
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    const res = UrlFetchApp.fetch(url, options);
    const result = JSON.parse(res.getContentText());
    if (result.choices && result.choices[0]) {
      return JSON.parse(result.choices[0].message.content);
    }
    throw new Error('Invalid response');
  } catch (e) {
    console.error('OpenAI API Error:', e);
    return {
      fourCharComment: "ç”¨å¿ƒå¯«ä½œå€¼å¾—é¼“å‹µ",
      feedback: "è€å¸«æ”¶åˆ°äº†ä½ çš„ä½œå“ï¼Œå…§å®¹éå¸¸æœ‰æ„ç¾©ï¼Œè«‹ç¹¼çºŒä¿æŒé€™ä»½å‰µä½œçš„ç†±æƒ…ï¼"
    };
  }
}
${emailCode}

// ============================================
// è¼”åŠ©å‡½æ•¸
// ============================================
function getFolder(folderName) {
  const folders = DriveApp.getFoldersByName(folderName);
  return folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);
}

function createResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// ============================================
// æ¸¬è©¦èˆ‡æˆæ¬Š
// ============================================
function manualAuthTest() {
  Logger.log("æ­£åœ¨æ¸¬è©¦æ¬Šé™...");
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheets()[0];
  Logger.log("è©¦ç®—è¡¨è®€å–æˆåŠŸ: " + sheet.getName());
  ${config.teacherEmail ? `MailApp.sendEmail(TEACHER_EMAIL, "æ¬Šé™æ¸¬è©¦", "å¦‚æœæ‚¨æ”¶åˆ°é€™å°ä¿¡ï¼Œä»£è¡¨ GAS éƒµä»¶æ¬Šé™å·²é–‹å•Ÿã€‚");
  Logger.log("æ¸¬è©¦éƒµä»¶å·²ç™¼é€ã€‚");` : '// æœªè¨­å®š Emailï¼Œè·³ééƒµä»¶æ¸¬è©¦'}
  Logger.log("æ¸¬è©¦å®Œæˆï¼");
}

function testOpenAIAPI() {
  const testContent = 'é€™æ˜¯ä¸€ä»½é—œæ–¼ç’°å¢ƒä¿è­·çš„å­¸ç¿’å ±å‘Šï¼Œå­¸ç”Ÿç ”ç©¶äº†æ°£å€™è®Šé·çš„å½±éŸ¿ã€‚';
  console.log('æ¸¬è©¦ OpenAI API...');
  try {
    const feedback = getOpenAIReview(testContent);
    console.log('OpenAI API æˆåŠŸï¼');
    console.log('ç”Ÿæˆçš„è©•èªï¼š', JSON.stringify(feedback, null, 2));
  } catch (error) {
    console.log('OpenAI API å¤±æ•—ï¼š' + error.message);
  }
}`;
        }

        function generateDeployGuide() {
            const title = document.getElementById('deployGuideTitle');
            const steps = document.getElementById('deploySteps');

            if (selectedDeploy === 'netlify') {
                title.textContent = 'Netlify + GAS éƒ¨ç½²æ­¥é©Ÿ';
                steps.innerHTML = `
                    <div class="deploy-step">
                        <span class="step-num">1</span>
                        <div class="step-content">
                            <p><strong>éƒ¨ç½² GAS ç¨‹å¼</strong> - å‰å¾€ <a href="https://script.google.com" target="_blank">Google Apps Script</a>ï¼Œå»ºç«‹æ–°å°ˆæ¡ˆï¼Œè²¼ä¸Š GAS ç¨‹å¼ç¢¼</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">2</span>
                        <div class="step-content">
                            <p><strong>å•Ÿç”¨ Drive API</strong> - åœ¨ GAS ç·¨è¼¯å™¨å·¦å´é»æ“Šã€Œæœå‹™ã€â†’ æ–°å¢ã€ŒDrive APIã€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">3</span>
                        <div class="step-content">
                            <p><strong>åŸ·è¡Œæˆæ¬Šæ¸¬è©¦</strong> - åŸ·è¡Œ manualAuthTest å‡½æ•¸ï¼Œå…è¨± Google æ¬Šé™</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">4</span>
                        <div class="step-content">
                            <p><strong>éƒ¨ç½²ç‚ºç¶²è·¯æ‡‰ç”¨ç¨‹å¼</strong> - é»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ã€â†’ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€<br>åŸ·è¡Œèº«åˆ†ï¼šã€Œæˆ‘ã€/ å­˜å–æ¬Šï¼šã€Œæ‰€æœ‰äººã€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">5</span>
                        <div class="step-content">
                            <p><strong>è¤‡è£½éƒ¨ç½²ç¶²å€</strong> - è¤‡è£½ç”¢ç”Ÿçš„ç¶²å€ï¼Œé€™å°±æ˜¯æ‚¨çš„ GAS API ç¶²å€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">6</span>
                        <div class="step-content">
                            <p><strong>æ›´æ–°ä¸»ç¨‹å¼</strong> - å°‡ GAS ç¶²å€å¡«å…¥ç”Ÿæˆå™¨çš„ã€ŒGAS éƒ¨ç½²ç¶²å€ã€æ¬„ä½ï¼Œé‡æ–°ç”Ÿæˆä¸»ç¨‹å¼</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">7</span>
                        <div class="step-content">
                            <p><strong>éƒ¨ç½²åˆ° Netlify</strong> - å‰å¾€ <a href="https://app.netlify.com/drop" target="_blank">Netlify Drop</a>ï¼Œå°‡ HTML æª”æ¡ˆæ‹–æ›³ä¸Šå‚³</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">8</span>
                        <div class="step-content">
                            <p><strong>è‡ªè¨‚ç¶²å€</strong> - åœ¨ Netlify çš„ã€ŒSite configurationã€ä¿®æ”¹ç¶²ç«™åç¨±ï¼Œä¾‹å¦‚ï¼šyour-class.netlify.app</p>
                        </div>
                    </div>
                `;
            } else {
                title.textContent = 'Gemini Canvas + GAS éƒ¨ç½²æ­¥é©Ÿ';
                steps.innerHTML = `
                    <div class="deploy-step">
                        <span class="step-num">1</span>
                        <div class="step-content">
                            <p><strong>éƒ¨ç½² GAS ç¨‹å¼</strong> - å‰å¾€ <a href="https://script.google.com" target="_blank">Google Apps Script</a>ï¼Œå»ºç«‹æ–°å°ˆæ¡ˆï¼Œè²¼ä¸Š GAS ç¨‹å¼ç¢¼</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">2</span>
                        <div class="step-content">
                            <p><strong>å•Ÿç”¨ Drive API</strong> - åœ¨ GAS ç·¨è¼¯å™¨å·¦å´é»æ“Šã€Œæœå‹™ã€â†’ æ–°å¢ã€ŒDrive APIã€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">3</span>
                        <div class="step-content">
                            <p><strong>åŸ·è¡Œæˆæ¬Šæ¸¬è©¦</strong> - åŸ·è¡Œ manualAuthTest å‡½æ•¸ï¼Œå…è¨± Google æ¬Šé™</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">4</span>
                        <div class="step-content">
                            <p><strong>éƒ¨ç½²ç‚ºç¶²è·¯æ‡‰ç”¨ç¨‹å¼</strong> - é»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ã€â†’ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€<br>åŸ·è¡Œèº«åˆ†ï¼šã€Œæˆ‘ã€/ å­˜å–æ¬Šï¼šã€Œæ‰€æœ‰äººã€</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">5</span>
                        <div class="step-content">
                            <p><strong>è¤‡è£½éƒ¨ç½²ç¶²å€</strong> - è¤‡è£½ç”¢ç”Ÿçš„ç¶²å€ï¼Œå¡«å…¥ç”Ÿæˆå™¨é‡æ–°ç”Ÿæˆä¸»ç¨‹å¼</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">6</span>
                        <div class="step-content">
                            <p><strong>é–‹å•Ÿ Gemini</strong> - å‰å¾€ <a href="https://gemini.google.com" target="_blank">Google Gemini</a>ï¼ˆéœ€ç™»å…¥ Google å¸³è™Ÿï¼‰</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">7</span>
                        <div class="step-content">
                            <p><strong>ä½¿ç”¨ Canvas åŠŸèƒ½</strong> - åœ¨ Gemini å°è©±ä¸­ï¼Œç›´æ¥è²¼ä¸Šä¸»ç¨‹å¼ HTML ç¨‹å¼ç¢¼ï¼Œä¸¦è¦æ±‚ Gemini é¡¯ç¤ºåœ¨ Canvas ä¸­</p>
                        </div>
                    </div>
                    <div class="deploy-step">
                        <span class="step-num">8</span>
                        <div class="step-content">
                            <p><strong>åŸ·è¡Œèˆ‡æ¸¬è©¦</strong> - Gemini Canvas æœƒå³æ™‚æ¸²æŸ“ç¶²é ï¼Œå¯ç›´æ¥é€²è¡Œæ¸¬è©¦ã€‚è‹¥éœ€åˆ†äº«ï¼Œå¯è«‹ Gemini ç”¢ç”Ÿåˆ†äº«é€£çµ</p>
                        </div>
                    </div>
                `;
            }
        }

        function copyCode(type) {
            const content = type === 'main'
                ? document.getElementById('mainCodeContent').textContent
                : document.getElementById('gasCodeContent').textContent;

            navigator.clipboard.writeText(content).then(() => {
                const btns = document.querySelectorAll(`#${type}CodeOutput .code-btn`);
                btns[0].textContent = 'å·²è¤‡è£½ï¼';
                btns[0].classList.add('copied');
                setTimeout(() => {
                    btns[0].textContent = 'è¤‡è£½ç¨‹å¼ç¢¼';
                    btns[0].classList.remove('copied');
                }, 2000);
            });
        }

        function downloadCode(type) {
            const content = type === 'main'
                ? document.getElementById('mainCodeContent').textContent
                : document.getElementById('gasCodeContent').textContent;

            const filename = type === 'main' ? 'index.html' : 'Code.gs';
            const mimeType = type === 'main' ? 'text/html' : 'text/plain';

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>
</html>
