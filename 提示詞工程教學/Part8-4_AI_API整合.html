<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part 8-4：AI API 整合</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0c1445 0%, #1a237e 50%, #283593 100%);
            min-height: 100vh;
            padding: 80px 20px 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(2px 2px at 20px 30px, white, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, white, transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 230px 80px, white, transparent),
                radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.7), transparent);
            background-size: 550px 250px;
            animation: twinkle 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(12, 20, 69, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-title {
            color: #a5d6a7;
            font-size: 18px;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn-top {
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
        }

        .nav-btn-top:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #a5d6a7;
            text-decoration: none;
            font-size: 16px;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(-5px);
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header .part-number {
            display: inline-block;
            background: linear-gradient(135deg, #00c300, #00e676);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 42px;
            margin-bottom: 15px;
            text-shadow: 0 4px 20px rgba(0, 230, 118, 0.5);
        }

        .header p {
            font-size: 20px;
            opacity: 0.9;
            color: #c8e6c9;
        }

        .content-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        .content-card h2 {
            color: #2e7d32;
            font-size: 26px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #00c300;
        }

        .content-card h3 {
            color: #388e3c;
            font-size: 20px;
            margin: 25px 0 15px 0;
        }

        .content-card p {
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 15px;
        }

        .api-selector {
            display: flex;
            gap: 20px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .api-option {
            flex: 1;
            min-width: 280px;
            background: #f5f5f5;
            border-radius: 15px;
            padding: 25px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .api-option:hover {
            border-color: #00c300;
            transform: translateY(-5px);
        }

        .api-option.active {
            border-color: #00c300;
            background: #e8f5e9;
        }

        .api-option h4 {
            font-size: 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-option.gemini h4 { color: #4285f4; }
        .api-option.openai h4 { color: #10a37f; }

        .api-option ul {
            list-style: none;
            font-size: 14px;
            color: #555;
        }

        .api-option li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .api-option li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #00c300;
        }

        .prompt-box {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left: 5px solid #ff6f00;
            padding: 25px;
            border-radius: 0 15px 15px 0;
            margin: 20px 0;
        }

        .prompt-box h4 {
            color: #e65100;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prompt-box pre {
            background: white;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.7;
            color: #333;
            white-space: pre-wrap;
        }

        .code-block {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .code-block h4 {
            color: #81d4fa;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .code-block pre {
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .code-block .comment { color: #6a9955; }
        .code-block .keyword { color: #569cd6; }
        .code-block .string { color: #ce9178; }
        .code-block .function { color: #dcdcaa; }

        .copy-btn {
            background: linear-gradient(135deg, #00c300, #00e676);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 200, 0, 0.4);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
        }

        .comparison-table th, .comparison-table td {
            padding: 15px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }

        .comparison-table th {
            background: linear-gradient(135deg, #00c300, #00e676);
            color: white;
            font-weight: 600;
        }

        .comparison-table tr:nth-child(even) {
            background: #f5f5f5;
        }

        .highlight-box {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-left: 5px solid #2e7d32;
            padding: 20px;
            border-radius: 0 12px 12px 0;
            margin: 20px 0;
        }

        .highlight-box h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .warning-box {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left: 5px solid #ff6f00;
            padding: 20px;
            border-radius: 0 12px 12px 0;
            margin: 20px 0;
        }

        .warning-box h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .step-list {
            list-style: none;
            counter-reset: step;
        }

        .step-list li {
            counter-increment: step;
            padding: 20px;
            padding-left: 70px;
            margin-bottom: 15px;
            background: #f5f5f5;
            border-radius: 12px;
            position: relative;
            transition: all 0.3s;
        }

        .step-list li:hover {
            background: #e8e8e8;
            transform: translateX(5px);
        }

        .step-list li::before {
            content: counter(step);
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #00c300, #00e676);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nav-btn {
            padding: 15px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn.prev {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .nav-btn.next {
            background: linear-gradient(135deg, #0277bd, #039be5);
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 28px; }
            .content-card { padding: 20px; }
            .api-selector { flex-direction: column; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <span class="nav-title">8-4 AI API 整合</span>
        <div class="nav-buttons">
            <a href="index2.html" class="nav-btn-top">首頁</a>
            <a href="Part9-1_四字評語生成.html" class="nav-btn-top">下一章</a>
            <button class="nav-btn-top" onclick="toggleFullscreen()">全螢幕</button>
            <a href="https://www.youtube.com/@Liang-yt02" target="_blank" class="nav-btn-top">YT</a>
            <a href="https://www.facebook.com/?locale=zh_TW" target="_blank" class="nav-btn-top">FB</a>
            <a href="https://www.facebook.com/groups/2754139931432955?locale=zh_TW" target="_blank" class="nav-btn-top">3A</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <div class="part-number">Part 8-4</div>
            <h1>AI API 整合</h1>
            <p>OpenAI GPT-4o / Gemini Integration</p>
        </div>

        <!-- API 選擇 -->
        <div class="content-card">
            <h2>選擇 AI 服務</h2>
            <p>根據需求選擇適合的 AI API。兩者都能生成高品質的學習評語，以下是比較：</p>

            <div class="api-selector">
                <div class="api-option gemini active" onclick="selectAPI('gemini')">
                    <h4>Gemini API</h4>
                    <ul>
                        <li>Google 開發，與 GAS 整合順暢</li>
                        <li>gemini-2.5-flash 快速且便宜</li>
                        <li>中文理解能力佳</li>
                        <li>免費額度較高</li>
                        <li>適合教育場景</li>
                    </ul>
                </div>
                <div class="api-option openai" onclick="selectAPI('openai')">
                    <h4>OpenAI GPT-4o</h4>
                    <ul>
                        <li>業界標竿，回應品質穩定</li>
                        <li>多模態能力強（圖片、語音）</li>
                        <li>豐富的 API 功能</li>
                        <li>較成熟的生態系統</li>
                        <li>適合進階應用</li>
                    </ul>
                </div>
            </div>

            <table class="comparison-table">
                <tr>
                    <th>比較項目</th>
                    <th>Gemini</th>
                    <th>OpenAI GPT-4o</th>
                </tr>
                <tr>
                    <td>價格（每百萬 token）</td>
                    <td>輸入 $0.075 / 輸出 $0.30</td>
                    <td>輸入 $5 / 輸出 $15</td>
                </tr>
                <tr>
                    <td>速度</td>
                    <td>較快（flash 版本）</td>
                    <td>中等</td>
                </tr>
                <tr>
                    <td>中文評語品質</td>
                    <td>優秀</td>
                    <td>優秀</td>
                </tr>
                <tr>
                    <td>免費額度</td>
                    <td>較高</td>
                    <td>較低</td>
                </tr>
                <tr>
                    <td>GAS 整合難度</td>
                    <td>簡單</td>
                    <td>簡單</td>
                </tr>
            </table>
        </div>

        <!-- Gemini 整合 -->
        <div class="content-card" id="gemini-section">
            <h2>Gemini API 整合</h2>

            <h3>Step 1：取得 API Key</h3>
            <ul class="step-list">
                <li>前往 <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a></li>
                <li>登入 Google 帳號，點擊「Get API Key」</li>
                <li>複製生成的 API Key</li>
                <li>在 GAS 中設定腳本屬性：<br><code>檔案 → 專案設定 → 腳本屬性 → 新增 GEMINI_API_KEY</code></li>
            </ul>

            <div class="prompt-box">
                <h4>向 AI 請求 Gemini 整合代碼</h4>
                <pre>請幫我寫 GAS 函數整合 Gemini API 生成學習評語，需求：

1. 函數名稱：generateFeedbackWithGemini(studentWork)
2. 使用 gemini-2.5-flash 模型
3. 輸入：學生作品文字
4. 輸出格式：
   {
     "fourChar": "○○○○・○○○○",
     "feedback": "50-80字具體評語",
     "score": 1-5分
   }
5. 評語要求：
   - 正面鼓勵為主
   - 指出 1-2 個具體優點
   - 提供 1 個改進建議
6. 加入錯誤處理</pre>
            </div>

            <div class="code-block">
                <h4>gemini-integration.gs - Gemini API 整合</h4>
                <pre><span class="comment">/**
 * 使用 Gemini API 生成學習評語
 * @param {string} studentWork - 學生作品內容
 * @returns {Object} 評語結果
 */</span>
<span class="keyword">function</span> <span class="function">generateFeedbackWithGemini</span>(studentWork) {
  <span class="keyword">const</span> API_KEY = PropertiesService.getScriptProperties().getProperty(<span class="string">'GEMINI_API_KEY'</span>);
  <span class="keyword">const</span> API_URL = <span class="string">`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`</span>;

  <span class="keyword">const</span> prompt = <span class="string">`你是一位溫暖的教育評量專家，請針對以下學生作品生成評語。

## 學生作品
${studentWork}

## 評語要求
1. 四字評語：使用「○○○○・○○○○」格式，如「探索未知・勇於嘗試」
2. 文字評語：50-80字，正面鼓勵為主
3. 評分：1-5分（5分最高）
4. 評語內容：
   - 指出 1-2 個具體優點
   - 提供 1 個溫和的改進建議
   - 使用第二人稱「你」

## 回傳格式（嚴格 JSON）
{
  "fourChar": "四字・四字",
  "feedback": "具體評語文字",
  "score": 數字
}`</span>;

  <span class="keyword">const</span> requestBody = {
    contents: [{
      parts: [{ text: prompt }]
    }],
    generationConfig: {
      temperature: 0.7,
      topP: 0.9,
      maxOutputTokens: 512
    },
    safetySettings: [
      { category: <span class="string">"HARM_CATEGORY_HARASSMENT"</span>, threshold: <span class="string">"BLOCK_NONE"</span> },
      { category: <span class="string">"HARM_CATEGORY_HATE_SPEECH"</span>, threshold: <span class="string">"BLOCK_NONE"</span> }
    ]
  };

  <span class="keyword">const</span> options = {
    method: <span class="string">'post'</span>,
    contentType: <span class="string">'application/json'</span>,
    payload: JSON.stringify(requestBody),
    muteHttpExceptions: <span class="keyword">true</span>
  };

  <span class="keyword">try</span> {
    <span class="keyword">const</span> response = UrlFetchApp.fetch(API_URL, options);
    <span class="keyword">const</span> result = JSON.parse(response.getContentText());

    <span class="keyword">if</span> (result.error) {
      Logger.log(<span class="string">'Gemini API Error: '</span> + result.error.message);
      <span class="keyword">return</span> getDefaultFeedback();
    }

    <span class="keyword">if</span> (result.candidates && result.candidates[0]) {
      <span class="keyword">const</span> text = result.candidates[0].content.parts[0].text;
      <span class="keyword">const</span> jsonMatch = text.match(/\{[\s\S]*\}/);
      <span class="keyword">if</span> (jsonMatch) {
        <span class="keyword">return</span> JSON.parse(jsonMatch[0]);
      }
    }

    <span class="keyword">return</span> getDefaultFeedback();
  } <span class="keyword">catch</span> (error) {
    Logger.log(<span class="string">'Gemini Error: '</span> + error.toString());
    <span class="keyword">return</span> getDefaultFeedback();
  }
}

<span class="comment">/**
 * 預設評語（API 失敗時使用）
 */</span>
<span class="keyword">function</span> <span class="function">getDefaultFeedback</span>() {
  <span class="keyword">return</span> {
    fourChar: <span class="string">"持續努力・未來可期"</span>,
    feedback: <span class="string">"感謝你的用心提交！老師已收到你的作品，將仔細閱讀後給予回饋。"</span>,
    score: 3
  };
}

<span class="comment">/**
 * 測試 Gemini 評語生成
 */</span>
<span class="keyword">function</span> <span class="function">testGemini</span>() {
  <span class="keyword">const</span> testWork = <span class="string">"我研究了太陽系的行星，發現木星是最大的行星，它有很多衛星。地球是唯一有生命的行星。"</span>;
  <span class="keyword">const</span> result = generateFeedbackWithGemini(testWork);
  Logger.log(JSON.stringify(result, <span class="keyword">null</span>, 2));
}</pre>
                <button class="copy-btn" onclick="copyCode(this)">複製程式碼</button>
            </div>
        </div>

        <!-- OpenAI 整合 -->
        <div class="content-card" id="openai-section">
            <h2>OpenAI GPT-4o 整合</h2>

            <h3>Step 1：取得 API Key</h3>
            <ul class="step-list">
                <li>前往 <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></li>
                <li>登入帳號，點擊「Create new secret key」</li>
                <li>複製生成的 API Key（只顯示一次）</li>
                <li>在 GAS 中設定腳本屬性：<br><code>檔案 → 專案設定 → 腳本屬性 → 新增 OPENAI_API_KEY</code></li>
            </ul>

            <div class="prompt-box">
                <h4>向 AI 請求 OpenAI 整合代碼</h4>
                <pre>請幫我寫 GAS 函數整合 OpenAI GPT-4o 生成學習評語，需求：

1. 函數名稱：generateFeedbackWithOpenAI(studentWork)
2. 使用 gpt-4o 模型
3. 使用 Chat Completions API
4. 輸入：學生作品文字
5. 輸出格式與 Gemini 版本相同
6. 加入 system prompt 設定教師角色
7. 加入錯誤處理和重試機制</pre>
            </div>

            <div class="code-block">
                <h4>openai-integration.gs - OpenAI API 整合</h4>
                <pre><span class="comment">/**
 * 使用 OpenAI GPT-4o 生成學習評語
 * @param {string} studentWork - 學生作品內容
 * @returns {Object} 評語結果
 */</span>
<span class="keyword">function</span> <span class="function">generateFeedbackWithOpenAI</span>(studentWork) {
  <span class="keyword">const</span> API_KEY = PropertiesService.getScriptProperties().getProperty(<span class="string">'OPENAI_API_KEY'</span>);
  <span class="keyword">const</span> API_URL = <span class="string">'https://api.openai.com/v1/chat/completions'</span>;

  <span class="keyword">const</span> systemPrompt = <span class="string">`你是一位經驗豐富、充滿愛心的教師。你的評語總是溫暖正面，能發現學生的優點並給予鼓勵。

評語規則：
- 使用繁體中文
- 四字評語格式：○○○○・○○○○（如「勤學好問・未來可期」）
- 文字評語 50-80 字
- 評分 1-5 分
- 先肯定優點，再溫和建議改進`</span>;

  <span class="keyword">const</span> userPrompt = <span class="string">`請評估以下學生作品，回傳 JSON 格式：

## 學生作品
${studentWork}

## 回傳格式
{
  "fourChar": "四字・四字",
  "feedback": "具體評語",
  "score": 數字
}`</span>;

  <span class="keyword">const</span> requestBody = {
    model: <span class="string">'gpt-4o'</span>,
    messages: [
      { role: <span class="string">'system'</span>, content: systemPrompt },
      { role: <span class="string">'user'</span>, content: userPrompt }
    ],
    temperature: 0.7,
    max_tokens: 500,
    response_format: { type: <span class="string">'json_object'</span> }
  };

  <span class="keyword">const</span> options = {
    method: <span class="string">'post'</span>,
    headers: {
      <span class="string">'Authorization'</span>: <span class="string">`Bearer ${API_KEY}`</span>,
      <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>
    },
    payload: JSON.stringify(requestBody),
    muteHttpExceptions: <span class="keyword">true</span>
  };

  <span class="keyword">try</span> {
    <span class="keyword">const</span> response = UrlFetchApp.fetch(API_URL, options);
    <span class="keyword">const</span> statusCode = response.getResponseCode();

    <span class="keyword">if</span> (statusCode !== 200) {
      Logger.log(<span class="string">'OpenAI API Error: '</span> + response.getContentText());
      <span class="keyword">return</span> getDefaultFeedback();
    }

    <span class="keyword">const</span> result = JSON.parse(response.getContentText());
    <span class="keyword">const</span> content = result.choices[0].message.content;
    <span class="keyword">return</span> JSON.parse(content);

  } <span class="keyword">catch</span> (error) {
    Logger.log(<span class="string">'OpenAI Error: '</span> + error.toString());
    <span class="keyword">return</span> getDefaultFeedback();
  }
}

<span class="comment">/**
 * 帶重試機制的 OpenAI 呼叫
 */</span>
<span class="keyword">function</span> <span class="function">generateFeedbackWithRetry</span>(studentWork, maxRetries = 3) {
  <span class="keyword">for</span> (<span class="keyword">let</span> i = 0; i < maxRetries; i++) {
    <span class="keyword">const</span> result = generateFeedbackWithOpenAI(studentWork);
    <span class="keyword">if</span> (result.fourChar && result.feedback) {
      <span class="keyword">return</span> result;
    }
    Utilities.sleep(1000 * (i + 1)); <span class="comment">// 指數退避</span>
  }
  <span class="keyword">return</span> getDefaultFeedback();
}

<span class="comment">/**
 * 測試 OpenAI 評語生成
 */</span>
<span class="keyword">function</span> <span class="function">testOpenAI</span>() {
  <span class="keyword">const</span> testWork = <span class="string">"我畫了一幅海底世界的圖，裡面有珊瑚、熱帶魚和海龜。我用了很多藍色和綠色。"</span>;
  <span class="keyword">const</span> result = generateFeedbackWithOpenAI(testWork);
  Logger.log(JSON.stringify(result, <span class="keyword">null</span>, 2));
}</pre>
                <button class="copy-btn" onclick="copyCode(this)">複製程式碼</button>
            </div>
        </div>

        <!-- 統一介面 -->
        <div class="content-card">
            <h2>統一介面：支援雙 API</h2>
            <p>設計一個統一的函數，可根據設定切換使用 Gemini 或 OpenAI：</p>

            <div class="code-block">
                <h4>unified-api.gs - 統一 API 介面</h4>
                <pre><span class="comment">/**
 * 統一評語生成介面
 * @param {string} studentWork - 學生作品
 * @param {string} provider - 'gemini' 或 'openai'（預設 gemini）
 */</span>
<span class="keyword">function</span> <span class="function">generateFeedback</span>(studentWork, provider = <span class="string">'gemini'</span>) {
  <span class="keyword">switch</span> (provider.toLowerCase()) {
    <span class="keyword">case</span> <span class="string">'openai'</span>:
    <span class="keyword">case</span> <span class="string">'gpt'</span>:
      <span class="keyword">return</span> generateFeedbackWithOpenAI(studentWork);
    <span class="keyword">case</span> <span class="string">'gemini'</span>:
    <span class="keyword">case</span> <span class="string">'google'</span>:
    <span class="keyword">default</span>:
      <span class="keyword">return</span> generateFeedbackWithGemini(studentWork);
  }
}

<span class="comment">/**
 * 從腳本屬性讀取預設 AI 服務
 */</span>
<span class="keyword">function</span> <span class="function">getDefaultProvider</span>() {
  <span class="keyword">return</span> PropertiesService.getScriptProperties().getProperty(<span class="string">'AI_PROVIDER'</span>) || <span class="string">'gemini'</span>;
}

<span class="comment">/**
 * LINE Bot 整合版本（用於 doPost）
 */</span>
<span class="keyword">function</span> <span class="function">processStudentSubmission</span>(userId, userName, message, replyToken) {
  <span class="comment">// 儲存到 Sheet</span>
  saveToSheet(userId, userName, message);

  <span class="comment">// 生成評語（使用預設服務）</span>
  <span class="keyword">const</span> provider = getDefaultProvider();
  <span class="keyword">const</span> feedback = generateFeedback(message, provider);

  <span class="comment">// 格式化 LINE 訊息</span>
  <span class="keyword">const</span> replyMessage = formatLineMessage(feedback);

  <span class="comment">// 回覆學生</span>
  replyToLine(replyToken, replyMessage);

  <span class="comment">// 儲存評語</span>
  saveFeedbackToSheet(userId, feedback);
}

<span class="comment">/**
 * 格式化 LINE 回覆訊息
 */</span>
<span class="keyword">function</span> <span class="function">formatLineMessage</span>(feedback) {
  <span class="keyword">return</span> <span class="string">`✨ ${feedback.fourChar} ✨

${feedback.feedback}

評分：${'★'.repeat(feedback.score)}${'☆'.repeat(5 - feedback.score)}`</span>;
}</pre>
                <button class="copy-btn" onclick="copyCode(this)">複製程式碼</button>
            </div>

            <div class="highlight-box">
                <h4>API Key 安全提醒</h4>
                <p>
                    <strong>永遠不要</strong>將 API Key 直接寫在程式碼中！<br>
                    請使用 <code>PropertiesService.getScriptProperties()</code> 儲存敏感資訊。<br>
                    設定方式：GAS 編輯器 → 檔案 → 專案設定 → 腳本屬性
                </p>
            </div>

            <div class="warning-box">
                <h4>API 使用限制</h4>
                <p>
                    <strong>Gemini：</strong>免費版每分鐘 15 次請求<br>
                    <strong>OpenAI：</strong>依帳戶層級不同，注意費用控管<br>
                    建議加入 <code>Utilities.sleep(1000)</code> 避免超過限制
                </p>
            </div>
        </div>

        <!-- 導航按鈕 -->
        <div class="nav-buttons">
            <a href="Part8-3_GAS程式碼撰寫.html" class="nav-btn prev">← 8-3 GAS 程式碼撰寫</a>
            <a href="Part9-1_四字評語生成.html" class="nav-btn next">Part 9-1 四字評語生成 →</a>
        </div>
    </div>

    <script>
        function copyCode(btn) {
            const codeBlock = btn.previousElementSibling;
            const code = codeBlock.textContent;
            navigator.clipboard.writeText(code).then(() => {
                btn.textContent = '已複製！';
                setTimeout(() => btn.textContent = '複製程式碼', 2000);
            });
        }

        function selectAPI(api) {
            document.querySelectorAll('.api-option').forEach(el => el.classList.remove('active'));
            document.querySelector('.api-option.' + api).classList.add('active');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>
</html>
