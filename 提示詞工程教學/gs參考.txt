åƒè€ƒ1:

// ============================================
// è‡ªä¸»å­¸ç¿’è©•èªæ©Ÿå™¨äºº - Google Apps Script
// ============================================

// è¨­å®šå¸¸æ•¸ï¼ˆè«‹æ›¿æ›ç‚ºä½ è‡ªå·±çš„ API Keysï¼‰
const LINE_CHANNEL_ACCESS_TOKEN = 'ä½ çš„_LINE_CHANNEL_ACCESS_TOKEN';
const OPENAI_API_KEY = 'ä½ çš„_OPENAI_API_KEY';
const GEMINI_API_KEY = 'ä½ çš„_GEMINI_API_KEY';
const GOOGLE_DRIVE_FOLDER_ID = 'ä½ çš„_GOOGLE_DRIVE_FOLDER_ID';
const SPREADSHEET_ID = 'ä½ çš„_SPREADSHEET_ID';

// ä½¿ç”¨è€…ç‹€æ…‹å­˜å„²ï¼ˆä½¿ç”¨ Script Propertiesï¼‰
const userProperties = PropertiesService.getScriptProperties();

// ============================================
// ä¸»è¦å…¥å£é» - æ¥æ”¶ LINE Webhook
// ============================================
function doPost(e) {
  try {
    const json = JSON.parse(e.postData.contents);
    const events = json.events;

    for (let i = 0; i < events.length; i++) {
      handleEvent(events[i]);
    }

    return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    console.error('doPost Error:', error);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ============================================
// äº‹ä»¶è™•ç†
// ============================================
function handleEvent(event) {
  const userId = event.source.userId;
  const replyToken = event.replyToken;

  // è™•ç†è¿½è¹¤äº‹ä»¶ï¼ˆåŠ å…¥å¥½å‹ï¼‰
  if (event.type === 'follow') {
    const welcomeMessage = 'ğŸ‘‹ æ­¡è¿ä½¿ç”¨ã€Œè‡ªä¸»å­¸ç¿’è©•èªæ©Ÿå™¨äººã€ï¼\n\n' +
      'ğŸ“ ä½¿ç”¨æ–¹å¼ï¼š\n' +
      'è¼¸å…¥ã€Œå¹«æˆ‘è©•èªã€å³å¯é–‹å§‹\n\n' +
      'æˆ‘æœƒæ ¹æ“šä½ çš„è‡ªä¸»å­¸ç¿’æˆæœçµ¦äºˆæ­£å‘çš„è©•èªå’Œå»ºè­°ï¼';
    replyMessage(replyToken, welcomeMessage);
    return;
  }

  // è™•ç†æ–‡å­—è¨Šæ¯
  if (event.type === 'message' && event.message.type === 'text') {
    const userMessage = event.message.text.trim();

    if (userMessage === 'å¹«æˆ‘è©•èª') {
      // è¨­å®šä½¿ç”¨è€…ç‹€æ…‹ç‚ºç­‰å¾…ä¸Šå‚³æª”æ¡ˆ
      setUserState(userId, 'waiting_for_file');

      const promptMessage = 'ğŸ“„ æˆ‘æ˜¯é˜¿äº®è€å¸«ï¼Œç¾åœ¨è«‹ä¸Šå‚³ä½ çš„è‡ªä¸»å­¸ç¿’æˆæœ PDF æª”æ¡ˆ\n\n' +
        'âš ï¸ æ³¨æ„äº‹é …ï¼š\n' +
        'â€¢ æª”æ¡ˆæ ¼å¼ï¼šåƒ…æ”¯æ´ PDF\n' +
        'â€¢ æª”æ¡ˆå¤§å°ï¼šå»ºè­° 10MB ä»¥å…§\n' +
        'â€¢ LINE æœ€å¤§é™åˆ¶ï¼š300MB\n\n' +
        'ğŸ’¡ æª”æ¡ˆå¤ªå¤§æ€éº¼è¾¦ï¼Ÿ\n' +
        'å¯ä»¥å…ˆåˆ° I Love PDF ç¶²ç«™å£“ç¸®ï¼š\n' +
        'https://www.ilovepdf.com/zh-tw/compress_pdf\n\n' +
        'ä¸Šå‚³å¾Œï¼Œæˆ‘æœƒä»”ç´°é–±è®€ä¸¦çµ¦ä½ å€‹äººå°ˆå±¬çš„è©•èªï¼';
      replyMessage(replyToken, promptMessage);
      return;
    }

    // å…¶ä»–æ–‡å­—è¨Šæ¯
    const helpMessage = 'ğŸ¤– æˆ‘æ˜¯è‡ªä¸»å­¸ç¿’è©•èªæ©Ÿå™¨äºº\n\n' +
      'è«‹è¼¸å…¥ã€Œå¹«æˆ‘è©•èªã€é–‹å§‹ä½¿ç”¨ï¼';
    replyMessage(replyToken, helpMessage);
    return;
  }

  // è™•ç†æª”æ¡ˆè¨Šæ¯
  if (event.type === 'message' && event.message.type === 'file') {
    const userState = getUserState(userId);

    if (userState !== 'waiting_for_file') {
      replyMessage(replyToken, 'è«‹å…ˆè¼¸å…¥ã€Œå¹«æˆ‘è©•èªã€ï¼Œå†ä¸Šå‚³æª”æ¡ˆå–”ï¼');
      return;
    }

    const fileName = event.message.fileName;
    const messageId = event.message.id;

    // æª¢æŸ¥æ˜¯å¦ç‚º PDF
    if (!fileName.toLowerCase().endsWith('.pdf')) {
      replyMessage(replyToken, 'âš ï¸ è«‹ä¸Šå‚³ PDF æ ¼å¼çš„æª”æ¡ˆï¼\n\nç›®å‰åƒ…æ”¯æ´ PDF æª”æ¡ˆæ ¼å¼ã€‚');
      return;
    }

    // å…ˆå›è¦†è™•ç†ä¸­è¨Šæ¯
    replyMessage(replyToken, 'â³ æ­£åœ¨è™•ç†ä½ çš„æª”æ¡ˆï¼Œè«‹ç¨å€™...\n\né€™å¯èƒ½éœ€è¦ 30 ç§’åˆ° 1 åˆ†é˜çš„æ™‚é–“ã€‚');

    // æ¸…é™¤ä½¿ç”¨è€…ç‹€æ…‹
    clearUserState(userId);

    // éåŒæ­¥è™•ç†æª”æ¡ˆï¼ˆä½¿ç”¨ push messageï¼‰
    processFileAsync(userId, messageId, fileName);
    return;
  }
}

// ============================================
// éåŒæ­¥è™•ç†æª”æ¡ˆ
// ============================================
function processFileAsync(userId, messageId, fileName) {
  try {
    // 1. å¾ LINE ä¸‹è¼‰æª”æ¡ˆ
    const fileBlob = downloadFileFromLine(messageId);

    // 2. å„²å­˜åˆ° Google Drive
    const file = saveFileToDrive(fileBlob, fileName, userId);

    // 3. æå– PDF æ–‡å­—å…§å®¹
    const pdfText = extractTextFromPdf(file);

    if (!pdfText || pdfText.trim().length < 10) {
      pushMessage(userId, 'âš ï¸ ç„¡æ³•è®€å– PDF å…§å®¹ï¼Œå¯èƒ½æ˜¯æƒææª”æˆ–åœ–ç‰‡å‹ PDFã€‚\n\nè«‹ç¢ºä¿ PDF å…§å«å¯é¸å–çš„æ–‡å­—ï¼Œæˆ–å˜—è©¦ä¸Šå‚³å…¶ä»–æª”æ¡ˆã€‚');
      return;
    }

    // 4. å‘¼å« OpenAI ç”Ÿæˆè©•èª
    const feedback = generateFeedback(pdfText);

    // 5. è¨˜éŒ„åˆ°è©¦ç®—è¡¨
    logToSpreadsheet(userId, fileName, feedback);

    // 6. å›å‚³è©•èªçµ¦å­¸ç”Ÿ
    const responseMessage = 'âœ¨ ä½ çš„è‡ªä¸»å­¸ç¿’è©•èª âœ¨\n\n' + feedback + '\n\n' +
      '---\nğŸ“Œ ç¹¼çºŒåŠ æ²¹ï¼æœ‰æ–°çš„å­¸ç¿’æˆæœæ­¡è¿å†æ¬¡åˆ†äº«ï¼';
    pushMessage(userId, responseMessage);

  } catch (error) {
    console.error('processFileAsync Error:', error);
    pushMessage(userId, 'âŒ è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message + '\n\nè«‹ç¨å¾Œå†è©¦ï¼Œæˆ–è¯ç¹«ç®¡ç†å“¡ã€‚');
  }
}

// ============================================
// LINE API ç›¸é—œå‡½å¼
// ============================================

// å¾ LINE ä¸‹è¼‰æª”æ¡ˆ
function downloadFileFromLine(messageId) {
  const url = 'https://api-data.line.me/v2/bot/message/' + messageId + '/content';
  const options = {
    method: 'get',
    headers: {
      'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN
    },
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);

  if (response.getResponseCode() !== 200) {
    throw new Error('ç„¡æ³•ä¸‹è¼‰æª”æ¡ˆï¼š' + response.getContentText());
  }

  return response.getBlob();
}

// å›è¦†è¨Šæ¯
function replyMessage(replyToken, message) {
  const url = 'https://api.line.me/v2/bot/message/reply';
  const payload = {
    replyToken: replyToken,
    messages: [{
      type: 'text',
      text: message
    }]
  };

  const options = {
    method: 'post',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  UrlFetchApp.fetch(url, options);
}

// ä¸»å‹•æ¨é€è¨Šæ¯
function pushMessage(userId, message) {
  const url = 'https://api.line.me/v2/bot/message/push';
  const payload = {
    to: userId,
    messages: [{
      type: 'text',
      text: message
    }]
  };

  const options = {
    method: 'post',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  UrlFetchApp.fetch(url, options);
}

// ============================================
// Google Drive ç›¸é—œå‡½å¼
// ============================================

// å„²å­˜æª”æ¡ˆåˆ° Google Drive
function saveFileToDrive(blob, fileName, userId) {
  const folder = DriveApp.getFolderById(GOOGLE_DRIVE_FOLDER_ID);

  // åŠ ä¸Šæ™‚é–“æˆ³å’Œç”¨æˆ¶IDé¿å…é‡è¤‡
  const timestamp = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyyMMdd_HHmmss');
  const newFileName = timestamp + '_' + userId.substring(0, 8) + '_' + fileName;

  blob.setName(newFileName);
  const file = folder.createFile(blob);

  return file;
}

// æå– PDF æ–‡å­—å…§å®¹
function extractTextFromPdf(file) {
  try {
    const blob = file.getBlob();
    const fileName = 'temp_pdf_' + new Date().getTime();

    // ä½¿ç”¨ Drive API å°‡ PDF è½‰æ›ç‚º Google Docsï¼ˆä¸ä½¿ç”¨ OCRï¼Œé¿å…é™åˆ¶ï¼‰
    const resource = {
      title: fileName,
      mimeType: 'application/vnd.google-apps.document'
    };

    // ç›´æ¥è½‰æ› PDF ç‚º Google Docs
    const docFile = Drive.Files.insert(resource, blob, {
      convert: true
    });

    // å–å¾—è½‰æ›å¾Œçš„æ–‡å­—å…§å®¹
    const doc = DocumentApp.openById(docFile.id);
    const text = doc.getBody().getText();

    // åˆªé™¤æš«å­˜æª”æ¡ˆ
    DriveApp.getFileById(docFile.id).setTrashed(true);

    console.log('PDF æå–æˆåŠŸï¼Œæ–‡å­—é•·åº¦ï¼š' + text.length);
    return text;

  } catch (error) {
    console.error('PDF è½‰æ›å¤±æ•—ï¼š' + error.message);
    return '';
  }
}

// ============================================
// OpenAI API ç›¸é—œå‡½å¼
// ============================================

function generateFeedback(pdfContent) {
  const url = 'https://api.openai.com/v1/chat/completions';

  // æ¨¡å‹å„ªå…ˆé †åºï¼šå…ˆç”¨ gpt-5.1ï¼Œå¤±æ•—å‰‡ç”¨ gpt-4.1
  const models = ['gpt-5.1', 'gpt-4.1'];

  // æˆªå–å…§å®¹ï¼ˆé¿å…è¶…é token é™åˆ¶ï¼‰
  const maxLength = 8000;
  const truncatedContent = pdfContent.length > maxLength
    ? pdfContent.substring(0, maxLength) + '...(å…§å®¹å·²æˆªå–)'
    : pdfContent;

  const systemPrompt = `ä½ æ˜¯ä¸€ä½æº«æš–ä¸”å°ˆæ¥­çš„æ•™è‚²è©•èªå°ˆå®¶ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šå­¸ç”Ÿçš„è‡ªä¸»å­¸ç¿’æˆæœï¼Œçµ¦äºˆæ­£å‘ã€é¼“å‹µæ€§çš„è©•èªã€‚

è©•èªè¦æ±‚ï¼š
1. å­—æ•¸ï¼š100-150å­—
2. èªæ°£ï¼šæº«æš–ã€æ­£å‘ã€é¼“å‹µ
3. å…§å®¹çµæ§‹ï¼š
   - è‚¯å®šå­¸ç”Ÿçš„åŠªåŠ›å’Œäº®é»
   - æŒ‡å‡ºå…·é«”çš„å„ªé»æˆ–é€²æ­¥
   - çµ¦äºˆæœªä¾†å­¸ç¿’çš„å»ºè­°
4. ä½¿ç”¨ç¹é«”ä¸­æ–‡
5. é¿å…ä½¿ç”¨éæ–¼åˆ¶å¼åŒ–çš„èªå¥`;

  const userPrompt = `è«‹æ ¹æ“šä»¥ä¸‹å­¸ç”Ÿçš„è‡ªä¸»å­¸ç¿’æˆæœï¼Œæ’°å¯«ä¸€æ®µè©•èªï¼š

===å­¸ç”Ÿä½œå“å…§å®¹===
${truncatedContent}
==================

è«‹çµ¦äºˆ 100-150 å­—çš„æ­£å‘è©•èªï¼ŒåŒ…å«è‚¯å®šã€é¼“å‹µå’Œæœªä¾†å»ºè­°ã€‚`;

  // å˜—è©¦æ¯å€‹æ¨¡å‹
  for (let i = 0; i < models.length; i++) {
    const currentModel = models[i];
    console.log('å˜—è©¦ä½¿ç”¨æ¨¡å‹ï¼š' + currentModel);

    const payload = {
      model: currentModel,
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt }
      ],
      max_tokens: 500,
      temperature: 0.7
    };

    const options = {
      method: 'post',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + OPENAI_API_KEY
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(url, options);
    const result = JSON.parse(response.getContentText());

    // å¦‚æœæˆåŠŸï¼Œå›å‚³çµæœ
    if (!result.error) {
      console.log('æˆåŠŸä½¿ç”¨æ¨¡å‹ï¼š' + currentModel);
      return result.choices[0].message.content.trim();
    }

    // å¦‚æœå¤±æ•—ä¸”é‚„æœ‰ä¸‹ä¸€å€‹æ¨¡å‹å¯ç”¨ï¼Œç¹¼çºŒå˜—è©¦
    console.log('æ¨¡å‹ ' + currentModel + ' å¤±æ•—ï¼š' + result.error.message);

    // å¦‚æœæ˜¯æœ€å¾Œä¸€å€‹æ¨¡å‹ä¹Ÿå¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤
    if (i === models.length - 1) {
      throw new Error('æ‰€æœ‰æ¨¡å‹éƒ½å¤±æ•—ï¼š' + result.error.message);
    }
  }
}

// ============================================
// Google è©¦ç®—è¡¨è¨˜éŒ„
// ============================================

function logToSpreadsheet(userId, fileName, feedback) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('è©•èªè¨˜éŒ„');

    // å¦‚æœå·¥ä½œè¡¨ä¸å­˜åœ¨ï¼Œå»ºç«‹æ–°çš„
    if (!sheet) {
      sheet = spreadsheet.insertSheet('è©•èªè¨˜éŒ„');
      // è¨­å®šæ¨™é¡Œåˆ—
      sheet.getRange(1, 1, 1, 5).setValues([['æ™‚é–“', 'ä½¿ç”¨è€…ID', 'æª”æ¡ˆåç¨±', 'è©•èª', 'ç‹€æ…‹']]);
      sheet.getRange(1, 1, 1, 5).setFontWeight('bold');
    }

    // æ–°å¢è¨˜éŒ„
    const timestamp = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy/MM/dd HH:mm:ss');
    const maskedUserId = userId.substring(0, 10) + '***'; // éƒ¨åˆ†é®è”½ç”¨æˆ¶ID

    sheet.appendRow([timestamp, maskedUserId, fileName, feedback, 'å®Œæˆ']);

  } catch (error) {
    console.error('logToSpreadsheet Error:', error);
  }
}

// ============================================
// ä½¿ç”¨è€…ç‹€æ…‹ç®¡ç†
// ============================================

function setUserState(userId, state) {
  userProperties.setProperty('state_' + userId, state);
}

function getUserState(userId) {
  return userProperties.getProperty('state_' + userId) || '';
}

function clearUserState(userId) {
  userProperties.deleteProperty('state_' + userId);
}

// ============================================
// æ¸¬è©¦å‡½å¼
// ============================================

function testBot() {
  console.log('Bot è¨­å®šæ¸¬è©¦...');
  console.log('LINE Token é•·åº¦:', LINE_CHANNEL_ACCESS_TOKEN.length);
  console.log('OpenAI Key é•·åº¦:', OPENAI_API_KEY.length);
  console.log('Drive Folder ID:', GOOGLE_DRIVE_FOLDER_ID);
  console.log('Spreadsheet ID:', SPREADSHEET_ID);
  console.log('æ¸¬è©¦å®Œæˆï¼');
}

// æ¸¬è©¦ PDF æå–åŠŸèƒ½ - æ‰‹å‹•åœ¨ GAS ä¸­åŸ·è¡Œ
function testPdfExtraction() {
  // å¾ Google Drive è³‡æ–™å¤¾å–å¾—æœ€æ–°çš„ PDF æª”æ¡ˆä¾†æ¸¬è©¦
  const folder = DriveApp.getFolderById(GOOGLE_DRIVE_FOLDER_ID);
  const files = folder.getFilesByType('application/pdf');

  if (!files.hasNext()) {
    console.log('è³‡æ–™å¤¾ä¸­æ²’æœ‰ PDF æª”æ¡ˆï¼Œè«‹å…ˆä¸Šå‚³ä¸€å€‹ PDF ä¾†æ¸¬è©¦');
    return;
  }

  const file = files.next();
  console.log('æ¸¬è©¦æª”æ¡ˆï¼š' + file.getName());

  const text = extractTextFromPdf(file);

  if (text && text.length > 0) {
    console.log('âœ… PDF æå–æˆåŠŸï¼');
    console.log('æ–‡å­—é•·åº¦ï¼š' + text.length);
    console.log('å‰ 500 å­—ï¼š\n' + text.substring(0, 500));
  } else {
    console.log('âŒ PDF æå–å¤±æ•—ï¼Œæ–‡å­—ç‚ºç©º');
  }
}

// æ¸¬è©¦ OpenAI API
function testOpenAI() {
  const testContent = 'é€™æ˜¯ä¸€ä»½é—œæ–¼ç’°å¢ƒä¿è­·çš„è‡ªä¸»å­¸ç¿’å ±å‘Šã€‚å­¸ç”Ÿç ”ç©¶äº†æ°£å€™è®Šé·çš„å½±éŸ¿ï¼Œä¸¦æå‡ºäº†æ¸›å°‘ç¢³æ’æ”¾çš„å»ºè­°ã€‚';

  console.log('æ¸¬è©¦ OpenAI API...');

  try {
    const feedback = generateFeedback(testContent);
    console.log('âœ… OpenAI API æˆåŠŸï¼');
    console.log('ç”Ÿæˆçš„è©•èªï¼š\n' + feedback);
  } catch (error) {
    console.log('âŒ OpenAI API å¤±æ•—ï¼š' + error.message);
  }
}

// Webhook é©—è­‰ç”¨
function doGet(e) {
  return ContentService.createTextOutput('LINE Bot is running!');
}



åƒè€ƒ2:
// ============================================
// è‡ªä¸»å­¸ç¿’è©•èªæ©Ÿå™¨äºº - Google Apps Script (Gemini ç‰ˆ)
// ============================================

// è¨­å®šå¸¸æ•¸
const LINE_CHANNEL_ACCESS_TOKEN = 'ä½ çš„_LINE_TOKEN';
const GEMINI_API_KEY = 'ä½ çš„_GEMINI_API_KEY'; 
const GOOGLE_DRIVE_FOLDER_ID = 'ä½ çš„_GoogleI_é›²ç«¯ç¡¬ç¢Ÿ_ID';
const SPREADSHEET_ID = 'ä½ çš„_GoogleI_è©¦ç®—è¡¨_ID';

// ä½¿ç”¨è€…ç‹€æ…‹å­˜å„²
const userProperties = PropertiesService.getScriptProperties();

// ============================================
// ä¸»è¦å…¥å£é»
// ============================================
function doPost(e) {
  try {
    const json = JSON.parse(e.postData.contents);
    const events = json.events;
    for (let i = 0; i < events.length; i++) {
      handleEvent(events[i]);
    }
    return ContentService.createTextOutput(JSON.stringify({ status: 'ok' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error' }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ============================================
// äº‹ä»¶è™•ç†
// ============================================
function handleEvent(event) {
  const userId = event.source.userId;
  const replyToken = event.replyToken;

  if (event.type === 'message' && event.message.type === 'text') {
    const userMessage = event.message.text.trim();
    if (userMessage === 'å¹«æˆ‘è©•èª') {
      setUserState(userId, 'waiting_for_file');
      replyMessage(replyToken, 'ğŸ“„ æˆ‘æ˜¯é˜¿äº®è€å¸«ï¼Œè«‹ä¸Šå‚³ PDF æª”æ¡ˆã€‚æˆ‘å·²å‡ç´šè‡³ Gemini 2.0 é ‚å°–æ¨¡å‹ç‚ºä½ æœå‹™ï¼');
      return;
    }
    replyMessage(replyToken, 'ğŸ¤– è«‹è¼¸å…¥ã€Œå¹«æˆ‘è©•èªã€é–‹å§‹ï¼');
  }

  if (event.type === 'message' && event.message.type === 'file') {
    const messageId = event.message.id;
    const fileName = event.message.fileName;
    if (getUserState(userId) === 'waiting_for_file' && fileName.toLowerCase().endsWith('.pdf')) {
      replyMessage(replyToken, 'â³ Gemini 2.0 æ­£åœ¨å…¨é€Ÿè§£æä¸­ï¼Œè«‹ç¨å€™...');
      clearUserState(userId);
      processFileAsync(userId, messageId, fileName);
    }
  }
}

// ============================================
// Gemini 2.0 æ ¸å¿ƒå‘¼å«å‡½å¼
// ============================================
function generateGeminiFeedback(pdfContent) {
  // ä½¿ç”¨ç›®å‰æœ€å¼·çš„ 2.0 Flash å¯¦é©—ç‰ˆæœ¬ï¼Œè‹¥è¦æ›å›ç©©å®šç‰ˆå¯æ”¹ç‚º gemini-1.5-pro
  const modelName = "gemini-2.5-flash"; 
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`;

  const systemPrompt = "ä½ æ˜¯ä¸€ä½å……æ»¿æ•™è‚²ç†±å¿±ã€æ–‡ç­†å„ªç¾ä¸”å°ˆæ¥­çš„è©•èªå°ˆå®¶ã€‚è«‹æ ¹æ“šå­¸ç”Ÿçš„è‡ªä¸»å­¸ç¿’æˆæœï¼Œæ’°å¯«ä¸€æ®µ 100-150 å­—çš„ç¹é«”ä¸­æ–‡è©•èªã€‚çµæ§‹ï¼š1.é«˜åº¦è‚¯å®š 2.å…·é«”åˆ†æå„ªé» 3.æä¾›é€²éšå»ºè­°ã€‚";

  const payload = {
    "contents": [{
      "parts": [{
        "text": `${systemPrompt}\n\nå­¸ç”Ÿä½œå“å…§å®¹ï¼š\n${pdfContent}`
      }]
    }],
    "generationConfig": {
      "temperature": 0.8,
      "maxOutputTokens": 1000
    }
  };

  const options = {
    "method": "post",
    "contentType": "application/json",
    "payload": JSON.stringify(payload),
    "muteHttpExceptions": true
  };

  const response = UrlFetchApp.fetch(url, options);
  const result = JSON.parse(response.getContentText());

  if (result.candidates && result.candidates[0].content) {
    return result.candidates[0].content.parts[0].text.trim();
  } else {
    throw new Error('æ¨¡å‹å›å‚³ç•°å¸¸ï¼š' + JSON.stringify(result));
  }
}

// ============================================
// æ”¯æ´å‡½å¼
// ============================================

function processFileAsync(userId, messageId, fileName) {
  try {
    const blob = downloadFileFromLine(messageId);
    const file = saveFileToDrive(blob, fileName, userId);
    const text = extractTextFromPdf(file);
    if (!text) throw new Error('ç„¡æ³•è®€å–æ–‡å­—');

    const feedback = generateGeminiFeedback(text);
    logToSpreadsheet(userId, fileName, feedback);
    pushMessage(userId, 'âœ¨ Gemini 2.0 è©•èª âœ¨\n\n' + feedback);
  } catch (e) {
    pushMessage(userId, 'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message);
  }
}

function downloadFileFromLine(id) {
  return UrlFetchApp.fetch('https://api-data.line.me/v2/bot/message/' + id + '/content', {
    headers: { 'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN }
  }).getBlob();
}

function replyMessage(token, text) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN },
    payload: JSON.stringify({ replyToken: token, messages: [{ type: 'text', text: text }] })
  });
}

function pushMessage(to, text) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + LINE_CHANNEL_ACCESS_TOKEN },
    payload: JSON.stringify({ to: to, messages: [{ type: 'text', text: text }] })
  });
}

function saveFileToDrive(blob, name, id) {
  blob.setName(`${Date.now()}_${name}`);
  return DriveApp.getFolderById(GOOGLE_DRIVE_FOLDER_ID).createFile(blob);
}

function extractTextFromPdf(file) {
  const resource = { title: file.getName(), mimeType: 'application/vnd.google-apps.document' };
  const docFile = Drive.Files.insert(resource, file.getBlob(), { convert: true });
  const text = DocumentApp.openById(docFile.id).getBody().getText();
  DriveApp.getFileById(docFile.id).setTrashed(true);
  return text;
}

function logToSpreadsheet(uid, name, fb) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheets()[0];
  sheet.appendRow([new Date(), uid, name, fb, 'Gemini 2.0']);
}

function setUserState(id, s) { userProperties.setProperty(id, s); }
function getUserState(id) { return userProperties.getProperty(id); }
function clearUserState(id) { userProperties.deleteProperty(id); }

